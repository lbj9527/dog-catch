## 运行指南

### 环境准备
- Node.js ≥ 18
- Redis ≥ 5（本地或远程）
- 可选：SMTP（发送邮箱验证码）
- 浏览器（前端播放器为静态站点）

### 安装依赖
- 后端：
```bash
cd backend && npm install
```
- 管理后台：
```bash
cd admin && npm install
```

### 环境变量（两环境一致策略，仅值不同）
- 必填：
  - `JWT_SECRET`：强随机密钥
  - `CORS_ORIGINS`：前端允许域名，例如 `http://localhost:3000,http://localhost:3001`
  - Redis 限流/标记：`REDIS_URL`（例如 `redis://localhost:6379`）
- hCaptcha：
  - `CAPTCHA_PROVIDER`: `hcaptcha`
  - `CAPTCHA_SITE_KEY`: 测试用 `10000000-ffff-ffff-ffff-000000000001`（生产请换正式）
  - `CAPTCHA_SECRET_KEY`: 测试用 `0x0000000000000000000000000000000000000000`（生产请换正式）
- 水印：
  - `SUB_WATERMARK`: `on`
  - `SUB_WM_DENSITY`: `med`
  - `SUB_WM_SECRET`: 强随机（建议不同于 `JWT_SECRET`）
- 可选 SMTP：
  - `SMTP_HOST`, `SMTP_PORT`, `SMTP_SECURE`, `SMTP_USER`, `SMTP_PASS`, `SMTP_FROM`

### 启动顺序
1) 启动 Redis
2) 启动后端（需在同一终端中带上环境变量）
   - Windows PowerShell（示例）：
```powershell
$env:JWT_SECRET='<强随机>'; $env:REDIS_URL='redis://127.0.0.1:6379'
$env:CORS_ORIGINS='http://localhost:3000,http://localhost:3001'
$env:CAPTCHA_PROVIDER='hcaptcha'
$env:CAPTCHA_SITE_KEY='10000000-ffff-ffff-ffff-000000000001'
$env:CAPTCHA_SECRET_KEY='0x0000000000000000000000000000000000000000'
cd backend; npm run dev
```
3) 启动播放器静态站点
```bash
cd frontend/public
set NO_UPDATE_NOTIFIER=1 && npx --yes serve@14.2.0 . -p 3000 --no-clipboard
```
4) 启动管理后台（可选）
```bash
cd admin; npm run dev
```

### 测试指南（关键安全点全量自测）
1) 登录可靠性
   - 未登录访问字幕：请求 `GET http://localhost:8000/api/subtitle/ABC-123` 应返回 `401`
   - 登录与校验：注册/登录后，前端播放器在启动时调用 `/api/user/verify`，若无效应立即登出并禁用字幕（观察 UI 按钮禁用）
2) 字幕加载
   - 登录后访问播放器 URL（带 `video` 参数）应可加载字幕；开关按钮变为“隐藏字幕”
   - 退出登录/注销账号后，字幕轨道应立即移除（无需刷新）
3) 限流（普通行为不受影响）
   - 用户维度（示例阈值）：
     - `/api/subtitle/:video_id`：20 次/5 分钟（突发 40）
     - `/api/subtitles/variants/:base`：10 次/5 分钟（突发 20）
   - IP 维度（示例阈值）：较高（2000 次/小时等），通常不易误伤
   - 触发 `429` 时返回 JSON：
```json
{ "error": "请求过于频繁", "requireCaptcha": true }
```
   - 同时服务端已在 Redis 标记需要 CAPTCHA（user/email/ip）
4) 扫描阈值（防枚举）
   - 在 10 分钟内请求大量不同 `video_id`/`base`（默认 40/30）
   - 预期：随后多次请求更易触发 `429` 且 `requireCaptcha: true`（进入降配窗口，默认 30 分钟）
5) CAPTCHA 流程
   - 触发 429 后，前端应切换到“带验证码”的登录/注册/发送验证码表单（需集成 hCaptcha 组件）
   - 获取 `captchaToken` 后再次提交（放在 `body.captchaToken` 或请求头 `x-captcha-token`）
   - 服务端使用 `CAPTCHA_SECRET_KEY` 向 hCaptcha 校验通过后放行
   - 开发联调提示：可先用 Postman 复现：对上述接口加头 `x-require-captcha: 1`，然后带上 `x-captcha-token` 提交（建议接入组件后真实获取 token）
6) 水印验证（追责能力）
   - 登录状态下拉取字幕文本：文件首部应包含 NOTE 行：`uid/hash`、`vid`、`ts`、`sig`（不影响显示）
   - 对话行尾随机存在零宽字符（不可见）
   - 同一字幕不同用户哈希应不同（文本层面）
7) Redis 验证
   - 观察 Redis 中的键：`rl:`（限流计数）、`scan:`（10 分钟窗口内的唯一集合）、`penalty:`（降配窗口）、`captcha:req:`（需要验证码标记）
   - 重启后端后，计数与标记仍保留（与内存实现不同）
8) 管理后台（管理员）
   - 用 admin 账号登录（上线前请修改默认口令）
   - 上传/预览/批量删除字幕均正常
   - 管理用户列表与统计可用
9) 跨域与安全头
   - 从 `http://localhost:3000` 访问后端 API 应被允许；其它来源应被 CORS 拦截
   - 响应头含常见安全头（Helmet）

### 常见问题
- server 启动即退出：`JWT_SECRET` 未设置或过弱
- Redis 相关：未配置 `REDIS_URL` 则退化为内存限流（开发可用，生产必须配置 Redis）
- hCaptcha 总是失败：检查 `CAPTCHA_SITE_KEY`/`CAPTCHA_SECRET_KEY` 是否为一对（开发用测试对）
- 静态站启动出现 serve 更新检查告警：已通过 `NO_UPDATE_NOTIFIER=1` 与固定 `serve@14.2.0` 规避

### 调参（环境变量）
- `SUBTITLE_RATE_USER_5MIN`（默认 20）、`SUBTITLE_BURST_USER`（40）
- `VARIANTS_RATE_USER_5MIN`（10）、`VARIANTS_BURST_USER`（20）
- `SUBTITLE_RATE_IP_1H`（2000）、`SUBTITLE_BURST_IP_10MIN`（400）
- `VARIANTS_RATE_IP_1H`（1000）、`VARIANTS_BURST_IP_10MIN`（200）
- `SCAN_UNIQUE_VIDEO_10MIN`（40）、`SCAN_UNIQUE_BASE_10MIN`（30）、`SCAN_PENALTY_WINDOW_MIN`（30）
- `SUB_WATERMARK=on|off`，`SUB_WM_DENSITY=low|med|high`

### 验收要点
- 未登录返回 `401`；登录后正常拉字幕
- 高频/批量枚举触发 `429` 且 `requireCaptcha:true`；加上 `captchaToken` 后可恢复
- 注销/改密后旧 token 立即失效；重新验证失败自动登出
- 水印存在且不影响播放；不同用户副本可区分

### 回滚与灰度
- 所有新特性均通过环境变量可开关与调参（限流阈值、水印开关/密度、CAPTCHA 强制开关），可逐步放量验证负载与体验