# Dog Catch 功能需求拆分（心愿单、字幕评论、用户广场）

本文将原有“完整方案（不含 PostgreSQL 迁移）”按功能拆分为三个可独立上线的需求任务：1) 心愿单、2) 字幕评论、3) 用户广场。三者按顺序逐个实现与验收，后续如需再进行 PostgreSQL 迁移。

全局约定（适用于三个任务）：

- 视频 ID 规范：`^[A-Za-z]+-\d{2,5}$`（大小写不敏感），入库统一大写。
- 分页方式：统一使用 cursor-based（时间倒序，必要时辅以自增 id），参数为 `cursor` 与 `limit`。
- 鉴权：沿用现有用户与管理员 token 机制（Authorization: Bearer ...）。
- 限流：对“发布类”接口实施轻量限流（按 user_id + IP）以防刷屏。
- SQLite：外键开关（PRAGMA foreign_keys=ON）、WAL、busy_timeout 等沿用先前建议。

---

## 1) 心愿单（Wishlist）

### 1.1 目标与范围

- 面向用户：添加/查看/删除个人心愿单条目。
- 面向运营（管理员）：心愿单列表（仅分页，不含筛选）与状态更新（未更新 / 已更新），显示用户 note。本期不做 admin_note，且不改用户 note。

### 1.2 数据结构（SQLite 优先，兼容 PG）

- `wishlist_items`
  - `id INTEGER PK`
  - `user_id INTEGER NOT NULL`（索引）
  - `requested_video_id TEXT NOT NULL`（索引，入库统一大写）
  - `note TEXT NULL`（0–300 字）
  - `status SMALLINT DEFAULT 0`（0=未更新，1=已更新）
  - `created_at DATETIME DEFAULT CURRENT_TIMESTAMP`（索引）
  - `updated_at DATETIME DEFAULT CURRENT_TIMESTAMP`
  - 约束：`UNIQUE(user_id, requested_video_id)`
- 说明：本期不做 `admin_note`，如后续需要可新增字段并迁移。

### 1.3 校验规范

- `requested_video_id`：正则校验 `^[A-Za-z]+-\d{2,5}$`，入库前转为大写。
- `note`：长度 0–300；`status` 仅允许 0/1。

### 1.4 后端 API

- 用户侧
  - `GET /api/wishlist/my?cursor=&limit=`：获取我的心愿单（时间倒序）。
  - `POST /api/wishlist`：`{ requested_video_id, note }`，校验并入库（转大写、唯一约束）。
  - `DELETE /api/wishlist/{id}`：删除本人心愿单条目（仅删除心愿单记录，不影响后台已上传的字幕文件）。
- 管理端
  - `GET /api/admin/wishlist?cursor=&limit=`：仅分页（cursor+limit），不提供筛选/搜索。
  - `PATCH /api/admin/wishlist/{id}`：`{ status }`（仅支持状态更新）。
- 鉴权：用户接口需登录；管理接口需管理员凭证。
- 分页：cursor-based；限流：对 POST 接口做轻量限流（user_id+IP）。

### 1.5 前端（播放器站点)

- 在头像菜单新增“我的心愿单”：
  - 入口显示：仅登录状态显示该菜单项；未登录时不显示“我的心愿单”入口。未登录用户可通过右上角“登录/注册”入口先完成登录，登录成功后菜单项将出现。
  - 弹窗（Modal）展示列表（分页）、新增表单（`requested_video_id` + `note`）、删除能力。
  - 输入校验：大小写不敏感，提交前转大写；格式必须匹配正则；`note` ≤ 300。

### 1.6 管理端（后台）

- 新增“用户心愿单”表格页面（可为独立菜单或放在用户管理下的页签）：
  - 不提供过滤或搜索功能。
  - 列表分页：cursor + limit 简单分页。
  - 表格列：用户名、心愿单 requested_video_id、note、处理状态（下拉：未更新 / 已更新）。
  - 运营可直接修改单条记录的处理状态，保存后即时生效（写入 `updated_at`）。
  - 前端用户登录后可在“我的心愿单”中同步看到该状态（未更新 / 已更新）。
- 支持状态更新，更新时写入 `updated_at`。
- 显示用户 `note`；本期不做 `admin_note`，且不允许修改用户 `note`。

### 1.7 验收标准

- 用户可正常添加/查看/删除心愿单；重复添加同一 `requested_video_id` 会被 UNIQUE 拦截并返回明确信息。
- 管理端可查看列表并更新状态（无筛选）；权限校验、参数校验、限流与分页均正确。
- SQLite 并发基础场景无长时间锁等待；错误处理与提示完整。

### 1.8 开发清单（拆分交付）

- 后端：建表与索引 → 用户接口 → 管理接口 → 限流与边界处理。
- 前端：菜单与弹窗骨架 → 列表 → 新增与删除 → 校验与交互打磨。
- 管理端：接口适配 → 列表页（无筛选，cursor 分页） → 状态更新 → 细节优化。

### 1.9 用户操作说明

- 入口：右上角头像菜单 → “我的心愿单”（仅登录后可见）。
- 未登录入口说明：未登录时不显示“我的心愿单”菜单项；请先通过右上角“登录/注册”完成登录，成功后该菜单项将出现并可访问。
- 浏览：打开后显示按时间倒序的我的心愿单列表，支持“加载更多”（基于 cursor 分页）。
- 新增：点击“新增”按钮，输入 requested_video_id（如 NINM-027）与 note（可选）；提交前自动转大写并进行格式与长度校验；提交成功后刷新列表首屏。
- 删除：在列表项右侧点击“删除”，仅能删除本人条目；删除仅影响心愿单条目，不会删除后台已上传的字幕文件。
- 状态查看：列表中展示运营处理状态（未更新 / 已更新），用户只读不可修改。
- 异常与提示：
  - 未登录：不显示“我的心愿单”菜单项；需先登录后再访问。
  - 校验失败：给出格式或长度不合法的明确提示。
  - 频繁提交：触发限流将提示稍后再试。

### 1.6 管理端（后台）

- 新增“用户心愿单”表格页面（可为独立菜单或放在用户管理下的页签）：
  - 不提供过滤或搜索功能。
+ - 列表分页：cursor + limit 简单分页。
  - 表格列：用户名、心愿单 requested_video_id、note、处理状态（下拉：未更新 / 已更新）。
  - 运营可直接修改单条记录的处理状态，保存后即时生效（写入 `updated_at`）。
  - 前端用户登录后可在“我的心愿单”中同步看到该状态（未更新 / 已更新）。
- 支持状态更新，更新时写入 `updated_at`。
- 显示用户 `note`；是否增加可编辑的 `admin_note` 由产品决定（本期可不做）。

### 1.7 验收标准

- 用户可正常添加/查看/删除心愿单；重复添加同一 `requested_video_id` 会被 UNIQUE 拦截并返回明确信息。
- 管理端可筛选并更新状态；权限校验、参数校验、限流与分页均正确。
- SQLite 并发基础场景无长时间锁等待；错误处理与提示完整。

### 1.8 开发清单（拆分交付）

- 后端：建表与索引 → 用户接口 → 管理接口 → 限流与边界处理。
- 前端：菜单与弹窗骨架 → 列表 → 新增与删除 → 校验与交互打磨。
- 管理端：接口适配 → 列表页（无筛选，cursor 分页） → 状态更新 → 细节优化。

### 1.9 用户操作说明

- 入口：右上角头像菜单 → “我的心愿单”。
- 浏览：打开后显示按时间倒序的我的心愿单列表，支持“加载更多”（基于 cursor 分页）。
- 新增：点击“新增”按钮，输入 requested_video_id（如 NINM-027）与 note（可选）；提交前自动转大写并进行格式与长度校验；提交成功后刷新列表首屏。
- 删除：在列表项右侧点击“删除”，仅能删除本人条目；删除仅影响心愿单条目，不会删除后台已上传的字幕文件。
- 状态查看：列表中展示运营处理状态（0/1/2），用户只读不可修改。
- 异常与提示：
  - 未登录：触发登录弹窗，引导登录后再操作。
  - 校验失败：给出格式或长度不合法的明确提示。
  - 频繁提交：触发限流将提示稍后再试。

---

## 2) 字幕评论（Comments）

### 2.1 目标与范围

- 基于 `base_video_id` 聚合的评论：登录后可发布，游客可浏览。
- 本期暂不实现“评论点赞”，如需可在后续加 `comment_likes`。

### 2.2 数据结构

- `comments`
  - `id INTEGER PK`
  - `base_video_id TEXT NOT NULL`（索引，入库统一大写）
  - `user_id INTEGER NOT NULL`（索引）
  - `content TEXT NOT NULL`（1–500 字）
  - `created_at DATETIME DEFAULT CURRENT_TIMESTAMP`（索引）
  - `status SMALLINT DEFAULT 1`（1=正常，0=隐藏/删除）
- 可选：`comment_likes`（后续）

### 2.3 校验规范

- `base_video_id`：正则校验，入库前转大写。
- `content`：长度 1–500；过滤空白、去除首尾空格。

### 2.4 后端 API

- `GET /api/comments?base_video_id=&cursor=&limit=`：按时间倒序返回评论流。
- `POST /api/comments`：`{ base_video_id, content }`，需登录；校验格式与长度。
- 鉴权与限流：发布接口限流（user_id+IP），列举接口不限或宽松限流。

### 2.5 前端（播放器站点）

- 在播放器下方操作栏新增两个 Tab 之一：“字幕评论”。
  - 默认折叠；首次点击加载；再次点击折叠；与“用户广场”互斥显示。
  - `baseVideoId = extractBaseId(currentSubtitleId || currentVideoId)`；同一 base 下切换字幕变体不刷新；当 base 变化时自动刷新评论流。
  - 未登录用户显示浏览列表，发布框隐藏；点击发布时唤起登录。

### 2.6 管理端（后台）

- 本期可不做；后续在列表中支持按 `status` 隐藏/删除评论。

### 2.7 验收标准

- 正确聚合至 `base_video_id`；分页、权限、校验、限流与错误提示均正确。
- 前端交互符合折叠/懒加载/切换规则；变体切换不刷新，base 变化才刷新。

### 2.8 开发清单（拆分交付）

- 后端：建表 → GET 列表 → POST 发布 → 限流与边界处理。
- 前端：操作栏与 Tab 骨架 → 列表渲染 → 发布框与交互 → 与点赞逻辑隔离验证。

### 2.9 用户操作说明

- 入口：播放器下方操作栏 → “字幕评论”Tab（位于点赞按钮右侧）。
- 展开/折叠：首次点击加载评论并展开内容区；再次点击折叠；与“用户广场”互斥显示。
- 浏览：按时间倒序显示评论列表，底部“加载更多”基于 cursor 分页。
- 发布：登录后显示输入框（1–500 字），点击发布提交；未登录点击发布将唤起登录弹窗。
- 切换视频/变体：
  - 同一 base_video_id 下切换字幕变体不刷新评论。
  - 当切换到不同 base 的视频时自动刷新评论流。
- 异常与提示：
  - 内容为空或超长：前端拦截并提示。
  - 触发限流：提示稍后再试。

---

## 3) 用户广场（Plaza）

### 3.1 目标与范围

- 全站时间线，纯文本内容；前端对 URL 自动链接（linkify）。
- 本期暂不实现“广场点赞/评论”，可后续通过 `post_likes`、`post_comments` 扩展。

### 3.2 数据结构

- `posts`
  - `id INTEGER PK`
  - `user_id INTEGER NOT NULL`（索引）
  - `content TEXT NOT NULL`（1–500 字）
  - `created_at DATETIME DEFAULT CURRENT_TIMESTAMP`（索引）
  - `status SMALLINT DEFAULT 1`
- 可选：`post_likes`、`post_comments`（后续）

### 3.3 校验规范

- `content`：长度 1–500；过滤空白、去除首尾空格。

### 3.4 后端 API

- `GET /api/plaza/posts?cursor=&limit=`：时间倒序的全站时间线。
- `POST /api/plaza/posts`：`{ content }`，需登录；长度校验，轻量限流。

### 3.5 前端（播放器站点）

- 在播放器下方操作栏新增两个 Tab 之一：“用户广场”。
  - 默认折叠；首次点击加载；再次点击折叠；与“字幕评论”互斥显示。
  - 渲染时对 `http(s)://...` 自动链接（`target=_blank`，`rel=noopener noreferrer`）。

### 3.6 管理端（后台）

- 本期可不做；后续可按 `status` 隐藏/删除动态。

### 3.7 验收标准

- 发布/列表/分页/校验/限流表现正确；前端 linkify 效果符合预期。

### 3.8 开发清单（拆分交付）

- 后端：建表 → GET 列表 → POST 发布 → 限流与边界处理。
- 前端：Tab 与列表骨架 → 发布框 → URL 自动链接渲染 → 交互与性能优化。

### 3.9 用户操作说明

- 入口：播放器下方操作栏 → “用户广场”Tab。
- 展开/折叠：与“字幕评论”一致，首次点击加载并展开；再点折叠；与“字幕评论”互斥显示。
- 浏览：按时间倒序显示全站动态，底部“加载更多”基于 cursor 分页；渲染时自动将 `http(s)://...` 链接化为可点击链接（新窗口打开，安全属性已设置）。
- 发布：登录后显示输入框（1–500 字），提交成功后新动态显示在列表顶部。
- 异常与提示：
  - 内容为空或超长：前端拦截并提示。
  - 触发限流：提示稍后再试。

---

## 实施顺序与发布策略

1. 心愿单：后端（表与 API）→ 前端（播放器菜单与弹窗）→ 管理端（状态更新）→ 验收。
2. 字幕评论：后端（表与 API）→ 前端（Tab 与评论流）→ 验收。
3. 用户广场：后端（表与 API）→ 前端（Tab 与时间线）→ 验收。

通过上述拆分，你可以逐个实现与上线，每完成一个功能即可自测与联调，满足验收标准后再进入下一个功能。
