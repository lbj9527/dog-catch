一、目标与范围

- 目标：在前端播放器中为"字幕版本"提供点赞功能，用于衡量用户对当前字幕版本的认可度。
- 范围：前端播放器页面（左下角区域）新增"点赞按钮与总点赞数展示"；当用户切换字幕文件（版本）时，点赞数随之刷新为该版本的统计。
- 不在本次范围：Admin 后台改动、用户脚本改动（如有需要可后续补充），本次仅聚焦播放器前端与必要的后端接口支持。

二、用户故事

- 作为观看者，我在播放视频时能看到当前字幕版本的累计点赞数，并且可以直接点赞该字幕版本，以表达该版本字幕质量较高。
- 当我切换到另一个字幕版本，点赞展示自动更新为该版本的累计点赞数。

三、UI/交互设计（前端播放器）

- 位置：播放器容器的左下角，常显一个"点赞"区域。
- 图标与平台规范：
  - 桌面端：拇指图标。
  - iOS 端：心形图标。
  - 状态样式：未点赞为空心，已点赞为实心并高亮；禁用态为灰色。
- 数字展示：
  - 点赞数支持千分位与缩写两种格式（例如 1,234 或 1.2k；≥1000 显示缩写 1.2k 样式）；
  - 仅支持中文文案（如"点赞""已点赞"）。
- 组成：
  - 一个可点击的"点赞"图标（桌面端：拇指；iOS 端：心形，未点赞空心、点赞后实心高亮）。
  - 右侧文本展示"历史总点赞数"（例如：2.3k 或 2,301，支持千分位与缩写 1.2k 样式）。
- 状态：
  - 未登录：图标禁用且为灰色，不显示总点赞数，点击时复用现有登录模态框引导登录。
  - 未点赞：图标为空心灰色，提示"点赞该字幕"。
  - 已点赞：图标为实心高亮，提示"已点赞，可取消"。
  - 加载中：切换字幕或初始化时图标禁用、数值显示为加载状态（或骨架屏）。
  - 错误：操作失败时轻提示（Toast/消息条），图标回退到上一次状态。
- 交互细节：
  - 点赞行为为"单击图标"。支持取消点赞，第二次点击则取消。
  - 切换字幕版本时：
    - 立即显示"加载中/禁用"态；
    - 使用防抖处理（300ms延迟），避免频繁切换时的重复请求；
    - 等待获取到该字幕版本的点赞统计后，恢复交互并展示正确数值与"我是否已点赞"的状态。
- 移动端适配：保证可触面积 ≥40px，点击反馈明显，区域不遮挡播放控制按钮。

四、数据与业务规则

- 点赞对象：具体某个"字幕版本（video_id/variant）"，而非整个视频或 base_video_id。
- 统计维度：展示"历史总点赞数"（累计计数），切换字幕版本时显示对应版本的计数。
- 已确认规则：
  - 允许点赞；
  - 未登录用户不允许点赞，且不显示总点赞数（点击时复用现有登录模态框引导登录）。
- 去重规则：
  - 同一用户对同一字幕版本只能点赞一次；若允许取消，则取消后可再次点赞。
- 乐观更新：点击后本地先加一（若是取消则减一），若服务器返回失败再回滚，提升体验。
- 恶意操作防护：前端节流/防抖，后端限流校验与唯一性约束，防刷。
- 数字格式：支持千分位与缩写（≥1000 显示 1.2k 样式），仅支持中文文案。

五、后端接口需求（建议方案）

结合现有后端 server.js 的认证体系与路由风格，建议新增：

- 获取点赞统计与我的点赞状态（登录用户可访问）
  - GET /api/subtitles/like-status/:video_id
  - 响应：{ likes_count: number, liked: boolean, video_id: string }
  - 鉴权：需登录（authenticateUserToken），未登录返回401。
- 点赞/取消点赞（需登录）
  - POST /api/subtitles/like-toggle/:video_id
  - 语义：若未点赞则插入点赞记录并 likes_count+1；若已点赞则删除记录并 likes_count-1（幂等）。
  - 响应：{ likes_count: number, liked: boolean, video_id: string }
  - 鉴权：需登录（authenticateUserToken）。
- 数据模型（SQLite）建议：
  - 新增表：subtitle_likes(id, user_id, video_id, created_at)，并对 (user_id, video_id) 建唯一索引；
  - 在现有 subtitles 表新增字段 likes_count（冗余计数）以加速展示，写入时增量维护或在事务中同步更新。

六、前端集成点

- 代码位置：播放器前端 player.js 负责挂载 UI 与事件。读取当前所选字幕版本（video_id/variant）并在切换事件时刷新点赞状态。
- 配置来源：config.js 提供后端 API 根路径与鉴权头（如 JWT）。
- 生命周期：
  - 初始化播放器 -> 检查登录状态 -> 若已登录则获取当前字幕版本 -> 调用 like-status 接口 -> 渲染按钮与计数；若未登录则显示禁用状态；
  - 监听"字幕版本切换"事件 -> 使用防抖处理（300ms） -> 重新获取 like-status -> 更新 UI；
  - 用户点击（已登录） -> 调用 like-toggle 接口 -> 根据返回更新 UI（使用乐观更新 + 回滚）；
  - 用户点击（未登录） -> 复用现有登录模态框引导登录。

七、权限与登录策略

- 沿用现有用户体系（server.js 已有注册/登录 JWT 流程）。
- 明确：未登录用户不允许点赞，且不显示总点赞数；点击时复用现有登录模态框引导登录。
- 所有写操作（like/unlike）必须在用户登录且鉴权通过后执行。

八、性能与防刷

- 前端：防抖/节流，避免频繁点击；在切换字幕时使用防抖处理（300ms延迟）合并请求。
- 后端：基于限流、事务与唯一约束确保"一人一赞"，并避免并发导致的计数不一致。

九、可观测性与回退

- 记录点赞/取消失败、接口延迟等指标，便于定位问题。
- 接口失败时，UI 给出轻提示并回退到稳定状态；不影响视频播放基础功能。

十、验收标准（Acceptance Criteria）

- 在播放器左下角能看到点赞图标，登录后显示总点赞数，且样式与状态清晰。
- 未登录时点赞按钮禁用且不显示总点赞数，点击时复用现有登录模态框。
- 初次加载时（登录状态下）显示当前字幕版本的正确累计点赞数。
- 切换字幕版本后，使用防抖处理，数值应在可接受时间内更新为对应版本的点赞数（建议 ≤300ms 内完成渲染）。
- 点击点赞后（登录态）：数值增加且图标变为"已点赞"；若支持取消，二次点击数值减少且图标恢复。
- 刷新页面后状态正确（我是否点赞、统计数值正确）。
- 图标平台规范符合要求（桌面端拇指、iOS 端心形；未点赞空心、点赞实心高亮）。
- 点赞数展示格式符合要求（千分位/缩写 1.2k），仅支持中文文案。
