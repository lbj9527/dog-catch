# 上线部署手册（海外·单机·示例域名）

适用场景：海外云主机单机部署，日活约 5000。示例域名使用 example.com（上线前请替换为你的真实域名）。

---

## 1. 基本规划
- 子域划分：
  - API：api.example.com（Node 后端，走反向代理）
  - 播放器：player.example.com（静态站点）
  - 管理后台：admin.example.com（静态站点）
- 服务器建议：2–4 vCPU / 4–8 GB RAM / 80–160 GB SSD，Ubuntu LTS
- 开放端口：80、443（其余仅内网访问，例如 Redis 6379）
- 目录结构（服务器）：
  - /opt/dog-catch/backend（后端代码）
  - /opt/dog-catch/frontend-dist（播放器静态）
  - /opt/dog-catch/admin-dist（管理后台静态）

## 2. 准备工作
1) DNS 解析
- 为 api/player/admin 三个子域添加 A/AAAA 记录指向服务器 IP

2) 基础软件
- Node.js LTS、Nginx、Redis、Git、Certbot（Nginx 插件）

```bash
# Ubuntu 示例（按需调整版本）
sudo apt update && sudo apt install -y nginx redis-server git curl
# Node.js LTS（以 18 为例）
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs
# Certbot
sudo apt install -y certbot python3-certbot-nginx
```

## 3. 证书签发（Let’s Encrypt）
```bash
# 先确保 Nginx 有基本的 server_name 与站点根/反代（见下文），再运行：
sudo certbot --nginx -d api.example.com -d player.example.com -d admin.example.com
# 按提示完成验证。自动安装/续期。
```

## 4. 后端部署（Node + PM2）
1) 上传代码到服务器：/opt/dog-catch/backend
```bash
cd /opt/dog-catch/backend
npm ci
```

2) 生产环境变量（务必使用安全真实值）
- 必填
  - JWT_SECRET=强随机≥32 字符
  - PORT=4000（或你自定义）
  - NODE_ENV=production
- 强烈建议
  - CORS_ORIGINS=https://player.example.com,https://admin.example.com
  - REDIS_URL=redis://127.0.0.1:6379/0（或云 Redis）
  - CAPTCHA_ENABLED=true
  - CAPTCHA_SITE_KEY=替换为生产站点 key
  - CAPTCHA_SECRET_KEY=替换为生产 secret
  - SMTP_HOST/SMTP_PORT/SMTP_USER/SMTP_PASS/SMTP_FROM
  - WATERMARK_ENABLED=true
  - WATERMARK_TEXT=YourBrand
  - WATERMARK_DENSITY=medium
  - SOCKS_PROXY_URL=（按需）

3) 进程守护（PM2 示例）
```bash
# 全局安装（如未安装）
sudo npm i -g pm2
# 启动（请在生产环境中通过系统环境文件注入上面的环境变量）
# 方式 A：一次性导出（仅示例，不建议放在 shell 历史）
export JWT_SECRET=... PORT=4000 NODE_ENV=production CORS_ORIGINS=https://player.example.com,https://admin.example.com
export REDIS_URL=redis://127.0.0.1:6379/0 CAPTCHA_ENABLED=true CAPTCHA_SITE_KEY=... CAPTCHA_SECRET_KEY=...
export SMTP_HOST=... SMTP_PORT=... SMTP_USER=... SMTP_PASS=... SMTP_FROM=...
export WATERMARK_ENABLED=true WATERMARK_TEXT=YourBrand WATERMARK_DENSITY=medium

pm2 start backend/src/server.js --name dog-catch-api
pm2 save
pm2 startup  # 按提示执行，设置开机自启
# 建议安装 logrotate：pm2 install pm2-logrotate
```

4) 重要检查
- 反向代理下建议启用：`app.set('trust proxy', 1)`（若尚未启用）
- 确保 CORS 白名单仅包含你的前台/后台域名
- Redis 正常连接，用于限流与风控

## 5. Nginx 配置（关键片段）
编辑 /etc/nginx/sites-available/dog-catch.conf（示例，按需调整路径）并链接到 sites-enabled。

```nginx
# API 反向代理
server {
    listen 80;
    server_name api.example.com;
    location / {
        return 301 https://$host$request_uri;
    }
}
server {
    listen 443 ssl http2;
    server_name api.example.com;
    # ssl_certificate 与 ssl_certificate_key 由 Certbot 自动填充

    location / {
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://127.0.0.1:4000;
        proxy_read_timeout 60s;
    }
}

# 播放器静态站点
server {
    listen 80;
    server_name player.example.com;
    return 301 https://$host$request_uri;
}
server {
    listen 443 ssl http2;
    server_name player.example.com;
    root /opt/dog-catch/frontend-dist;
    index index.html;
    location / {
        try_files $uri $uri/ /index.html;
    }
    location ~* \.(js|css|svg|woff2?)$ {
        add_header Cache-Control "public, max-age=31536000, immutable";
    }
}

# 管理后台静态站点
server {
    listen 80;
    server_name admin.example.com;
    return 301 https://$host$request_uri;
}
server {
    listen 443 ssl http2;
    server_name admin.example.com;
    root /opt/dog-catch/admin-dist;
    index index.html;
    location / {
        try_files $uri $uri/ /index.html;
    }
    location ~* \.(js|css|svg|woff2?)$ {
        add_header Cache-Control "public, max-age=31536000, immutable";
    }
}
```

```bash
sudo ln -s /etc/nginx/sites-available/dog-catch.conf /etc/nginx/sites-enabled/
sudo nginx -t && sudo systemctl reload nginx
```

## 6. 前台播放器部署
- 修改 e:/pythonProject/chrome-extension/dog-catch/frontend/public/config.js：
  - API_BASE_URL = "https://api.example.com"
  - CAPTCHA_SITE_KEY = "替换为生产 key"
- 将 frontend/public 中的全部文件上传至 /opt/dog-catch/frontend-dist（或使用更规范的构建/托管方式）

## 7. 管理后台部署
```bash
cd /opt/dog-catch/admin
# 首次构建
npm ci
# 设置生产环境变量：编辑 admin/.env.production
# VITE_API_BASE_URL=https://api.example.com
npm run build
# 将 dist 内容上传/部署到 /opt/dog-catch/admin-dist
```

## 8. 数据与备份
- SQLite 路径（在项目中）：backend/database/subtitles.db
- 上传目录：backend/uploads/
- 建议：
  - 启用 WAL 模式与 busy_timeout（如有并发写入）
  - 每日离线备份数据库与上传目录（tar/gzip + 保留 7–30 天）

## 9. 验收清单
- 登录/注册/邮箱验证码/失效重登流程可用
- 字幕：上传/预览/更新/删除/批量操作/统计
- 播放：HLS/MP4、清晰度切换、字幕切换
- 安全：CORS 白名单、Helmet 安全头、限流命中、hCaptcha 生效
- 水印：生成字幕内可检出且不被缓存（Cache-Control: no-store）
- 邮件：验证码可达率正常
- 监控与日志：无敏感信息泄露，错误可定位

## 10. 运维建议
- 使用 PM2 logrotate 进行日志轮转，避免日志撑满磁盘
- 定期更换 JWT_SECRET，及时修补依赖漏洞（npm audit）
- 若流量上升：优先将静态站点上 CDN；后端引入多实例 + 负载均衡 + 共享 Redis

---

如需，我可以根据你的真实域名与服务器环境，输出可直接复制的 Nginx 配置与一键部署脚本（含 PM2/Certbot/备份策略）。