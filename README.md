# Dog-Catch 🐾

智能媒体资源检测与预览工具 - Chrome 浏览器扩展

## 📋 项目概述

Dog-Catch 是一个专业的 Chrome 浏览器扩展，专注于网页媒体资源的智能检测与预览。基于现代化的 Web 技术栈，提供高效、稳定的媒体资源管理解决方案。

## �🏗️ 技术架构

### 前端技术栈

- **JavaScript ES6+** - 现代化 JavaScript 语法
- **CSS3** - 响应式设计和动画效果
- **HTML5** - 语义化标记和现代 Web API

### 浏览器扩展技术

- **Manifest V3** - 最新的扩展规范
- **Service Worker** - 后台服务和网络监听
- **Content Scripts** - 页面内容操作和资源注入
- **webRequest API** - 网络请求拦截和分析
- **Storage API** - 本地数据存储和配置管理

### 核心依赖

- **Video.js** - 开源 HTML5 视频播放器框架
- **Video.js HLS** - HLS 流媒体支持插件
- **Video.js DASH** - DASH 流媒体支持插件

## 🚀 功能特性

### 资源检测特性

- ✅ 实时网络监听
- ✅ 多线程并发检测
- ✅ 智能资源分类
- ✅ 文件大小和时长识别
- ✅ 资源质量评估
- ✅ 批量导出功能

### 媒体预览特性

- ✅ 即时预览播放
- ✅ 自适应播放器界面
- ✅ 多种播放模式
- ✅ 播放历史记录
- ✅ 收藏和标签管理
- ✅ 播放统计分析

## 📦 安装使用

### 开发环境要求

- Chrome 浏览器 88+ 版本
- 开发者模式已启用
- Node.js 16+ (用于构建工具)

### 安装步骤

1. 克隆项目到本地
2. 在 Chrome 中打开扩展管理页面 (`chrome://extensions/`)
3. 启用"开发者模式"
4. 点击"加载已解压的扩展程序"
5. 选择项目根目录

## 🔧 开发计划

### 第一阶段：总体架构设计 🏗️

- [ ] 设计 MVC 架构模式和模块划分
- [ ] 创建 manifest.json 配置文件（Manifest V3 规范）
- [ ] 搭建 Service Worker 后台服务（Controller 层）
- [ ] 建立消息通信机制和事件系统
- [ ] 实现基础的 Content Script 注入框架
- [ ] 定义数据模型和接口规范（Model 层）
- [ ] 设计界面组件架构（View 层）
- [ ] 建立扩展生命周期管理
- [ ] 配置 webRequest API 权限和网络监听基础
- [ ] 设计 Storage API 数据存储架构

### 第二阶段：界面层开发 (View) 🎨

#### 界面设计理念实现

- [ ] 采用现代化扁平设计风格，简洁直观的用户界面
- [ ] 确保在任何网站和页面环境下保持统一的视觉风格和交互体验
- [ ] 实现响应式布局，自适应不同屏幕尺寸
- [ ] 确保界面元素不干扰原网页内容，可随时隐藏或最小化

#### 跨站点一致性方案

- [ ] 使用 Shadow DOM 技术隔离样式，防止网站 CSS 干扰
- [ ] 所有样式使用唯一前缀或 CSS-in-JS 方案，避免样式冲突
- [ ] 使用系统字体栈，确保在任何环境下的字体显示一致性

#### 轻量级 UI 组件库

- [ ] 采用轻量级 CSS 框架（如 Tailwind CSS 或 Pure.css）实现快速样式开发
- [ ] 集成 Feather Icons 或 Lucide 等轻量级图标库，提供一致的视觉符号
- [ ] 使用 CSS3 原生动画和过渡效果，避免重型 JavaScript 动画库
- [ ] 构建可复用的 UI 组件（按钮、卡片、列表项等），确保界面一致性

#### 核心界面组件

- [ ] 实现资源列表面板（展示检测到的媒体资源，支持按文件类型筛选）
- [ ] 开发资源预览系统：
  - [ ] 简单预览 - 在资源卡片中点击预览按钮，展开卡片内的小窗口，使用简单播放器在卡片中直接播放
  - [ ] 详细预览 - 点击播放按钮，单独打开新网页，使用完整的 Video.js 播放器
- [ ] 开发工具栏（包含深度搜索、设置功能按钮的操作工具栏）

#### 插件操作控制

- [ ] 实现打开插件（点击浏览器扩展栏中的 Dog-Catch 图标打开插件界面）
- [ ] 实现关闭插件（点击插件界面右上角的关闭按钮）
- [ ] 支持固定显示（将插件界面固定在页面上，不随页面滚动而移动）
- [ ] 支持浮动模式（插件界面可以浮动显示，支持拖拽到页面任意位置）
- [ ] 支持最小化（将插件界面最小化为小图标，节省页面空间）

#### 交互体验优化

- [ ] 提供加载动画和进度指示，优化等待体验
- [ ] 友好的错误提示和恢复建议，提升用户体验

#### 移动端支持

- [ ] 移动端优化的资源列表界面，支持触摸滚动浏览
- [ ] Video.js 移动端播放器，支持触摸控制和全屏播放

#### 界面架构分离

- [ ] 严格分离界面展示层（View）与业务逻辑层（Controller）
- [ ] 将界面拆分为独立的功能组件（资源列表、播放器、工具栏等）
- [ ] 通过事件系统实现界面与后台逻辑的松耦合通信

### 第三阶段：自动嗅探功能 �(启动时自动嗅探)

**⚠️ 严格移植 cat-catch 成熟做法，禁止自主实现**

#### 完整的 webRequest 监听体系

- [ ] 实现 onSendHeaders - 捕获请求头，存储到 `G.requestHeaders` Map，并进行正则匹配检测
- [ ] 实现 onResponseStarted - 获取响应头，关联请求头数据，进行完整的资源类型判断
- [ ] 实现 onErrorOccurred - 清理失败请求的缓存数据，防止内存泄漏
- [ ] 实现正则匹配系统 - `G.Regex` 支持自定义正则规则匹配资源
- [ ] 实现黑名单机制 - `G.blackList` Set 结构屏蔽特定资源，防止重复处理

#### Service Worker 生命周期管理

- [ ] 实现心跳保活机制 - 通过 `chrome.runtime.onConnect` 和 250 秒定时器防止 Service Worker 被强制终止
- [ ] 实现初始化状态检查 - `G.initSyncComplete` 和 `G.initLocalComplete` 确保配置加载完成
- [ ] 实现自动重启恢复 - Service Worker 重启后通过 233ms 延迟重试机制恢复检测

#### 多层级资源过滤检测

- [ ] 实现 URL 路径解析 - `fileNameParse` 函数从 pathname 提取文件名和扩展名
- [ ] 实现响应头完整解析 - `getResponseHeadersValue` 解析 Content-Type、Content-Length、Content-Disposition、Content-Range
- [ ] 实现扩展名过滤 - 基于默认扩展名列表（MP4、M3U8、MPD、WebM、FLV、MP3、AAC 等）进行过滤，通过 `CheckExtension` 函数验证
- [ ] 实现 MIME 类型智能检测 - `CheckType` 支持 video/_、audio/_、application/dash+xml 等类型识别
- [ ] 实现特殊资源类型处理 - 自动放行 `data.type == "media"` 的浏览器原生媒体资源
- [ ] 实现附件文件名解析 - 从 Content-Disposition 响应头中提取 filename 参数，支持编码文件名

#### 资源信息构建

- [ ] 实现基础信息构建 - name, url, size, ext, type 等资源基本属性
- [ ] 实现页面信息获取 - 获取当前页面的 title 和 webUrl

#### 高性能去重与缓存机制

- [ ] 实现 URL 指纹去重 - `G.urlMap` 使用 Set 数据结构进行 O(1) 去重检查
- [ ] 实现性能保护 - 超过 500 条记录时自动清空去重缓存，防止内存占用过多
- [ ] 实现分页面缓存 - 每个页面独立的 `cacheData[tabId]` 数组，桌面端最大支持 9999 条记录，移动端 999 条
- [ ] 实现智能防抖存储 - 高频检测时的详细逻辑：
  - [ ] 当前标签媒体数量大于 100 时开启防抖，等待 5 秒或积累 10 个资源后存储
  - [ ] 时间间隔小于 500 毫秒时等待 2 秒存储，批量处理减少 I/O 操作

#### 实时更新与通知机制

- [ ] 实现增量更新 - 新检测到的资源实时添加到缓存数组，触发界面更新
- [ ] 实现角标实时更新 - `SetIcon` 函数动态更新扩展图标数字，支持 999+ 显示，标签切换时同步更新
- [ ] 实现存储同步 - `chrome.storage.session ?? chrome.storage.local` 优先级机制，确保数据持久化

#### 错误处理与异常保护

- [ ] 实现特殊页面过滤 - `isSpecialPage` 自动屏蔽 chrome://、moz-extension:// 等特殊协议
- [ ] 实现异常捕获 - 所有关键函数都有 try-catch 保护，确保单个资源错误不影响整体检测

### 第四阶段：深度搜索功能 �（手动触发）

**⚠️ 严格移植 cat-catch 成熟做法，禁止自主实现**

#### 脚本注入机制

- [ ] 实现通过 `chrome.scripting.executeScript` 注入 `search.js` 到页面主世界（MAIN world）

#### 多重 API 劫持技术

- [ ] 实现 XMLHttpRequest 劫持 - 重写 `XMLHttpRequest.prototype.open` 监听所有 AJAX 请求和响应
- [ ] 实现 Fetch API 劫持 - 代理 `window.fetch` 捕获现代异步请求中的媒体资源
- [ ] 实现编码函数劫持 - 劫持 `btoa/atob`、`escape`、`String.fromCharCode` 检测编码的媒体内容
- [ ] 实现数组操作劫持 - 劫持 `Array.prototype.slice` 检测数组切片中的加密密钥
- [ ] 实现 Worker 构造劫持 - 劫持 `Worker` 构造函数，向 Web Worker 注入检测脚本

#### 加密密钥智能检测

- [ ] 实现 16 字节密钥检测 - 检测 Array[16]、ArrayBuffer(16) 格式的 AES 密钥，验证数组元素为数字且 ≤ 256
- [ ] 实现 32 字节密钥检测 - 检测 ArrayBuffer(32) 格式的扩展密钥
- [ ] 实现 Base64 密钥检测 - 检测长度为 24 且以"=="结尾的 Base64 编码密钥
- [ ] 实现重复扩展检测 - 检测 256/128 字节的重复扩展密钥模式
- [ ] 实现字符串密钥检测 - 检测 32 字符长度的字符串密钥

#### 媒体内容深度识别

- [ ] 实现 M3U8 播放列表识别 - 识别 "#EXTM3U" 开头的 HLS 播放列表内容
- [ ] 实现 MPD 清单文件识别 - 识别包含 "urn:mpeg:dash:schema:mpd" 的 DASH 清单
- [ ] 实现 Data URI 解码 - 解码 data: 协议中的 Base64 编码媒体内容
- [ ] 实现分片 M3U8 重组 - 通过 `String.fromCharCode` 重组分片传输的 M3U8 内容

#### 高级搜索功能

- [ ] 实现 JavaScript 变量递归扫描 - 最大深度 10 层的对象递归遍历，查找隐藏的媒体 URL，防止死循环
- [ ] 实现特殊平台定制处理 - Vimeo CDN 资源（vimeocdn.com）的专项识别和处理算法
- [ ] 实现实时通信机制 - 通过 `postMessage` 将发现的资源和密钥实时发送到后台脚本

### 第五阶段：Video.js 媒体预览 🎬

#### 专业播放器框架

- [ ] 集成开源 Video.js 框架，基于 HTML5 video 元素的全功能播放器

#### 多格式原生支持

- [ ] 实现 HLS 流媒体支持 - 原生支持 HTTP Live Streaming (M3U8) 播放列表
- [ ] 实现 DASH 流媒体支持 - 支持 Dynamic Adaptive Streaming (MPD) 清单文件
- [ ] 实现传统格式支持 - MP4、WebM、OGG 等标准视频格式
- [ ] 实现音频格式支持 - MP3、AAC、OGG 等音频文件播放

#### 字幕系统

- [ ] 实现 WebVTT 标准支持 - 原生支持 W3C WebVTT 字幕格式
- [ ] 实现多格式兼容 - 通过插件支持 SRT、ASS 等字幕格式本地加载
- [ ] 实现字幕控制 - `TextTrack API` 提供字幕显示/隐藏/选择功能
- [ ] 实现多语言支持 - 支持多语言字幕轨道切换和 BCP 47 语言标签

#### 完整播放控制

- [ ] 实现基础控制 - `play()`、`pause()`、`currentTime()`、`duration()` 等 API
- [ ] 实现音量控制 - `volume()`、`muted()` 音量和静音控制
- [ ] 实现播放速度控制 - `playbackRate()` 支持 0.25x 到 4x 变速播放
- [ ] 实现进度控制 - `seekable()`、`seeking()` 精确进度控制和拖拽

#### 全屏与画中画

- [ ] 实现全屏模式 - `requestFullscreen()` 和 `exitFullscreen()` 原生全屏支持
- [ ] 实现全屏检测 - `supportsFullScreen()` 检测浏览器全屏能力
- [ ] 实现移动端适配 - 在不支持原生全屏的设备上提供"全窗口模式"

#### 高级功能

- [ ] 实现缓冲管理 - `buffered()` 获取缓冲状态和时间范围
- [ ] 实现错误处理 - `error()` 完善的错误检测和恢复机制

### 第六阶段：测试与发布 🧪

- [ ] 功能测试和 Bug 修复
- [ ] 性能优化和内存管理
- [ ] 兼容性测试
- [ ] 用户体验优化

## 📄 许可证

MIT License - 详见 LICENSE 文件

## 🤝 贡献指南

欢迎提交 Issue 和 Pull Request 来帮助改进项目！

---

**开发状态**: 🚧 正在开发中
**当前版本**: v0.1.0-dev
**最后更新**: 2025-08-09
