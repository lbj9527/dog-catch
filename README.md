# Dog-Catch 🐾

智能媒体资源检测与预览工具 - Chrome 浏览器扩展

## 📋 项目概述

Dog-Catch 是一个专业的 Chrome 浏览器扩展，专注于网页媒体资源的智能检测与预览。基于现代化的 Web 技术栈，提供高效、稳定的媒体资源管理解决方案。

## 🎯 核心功能

### 1. 🔍 资源自动嗅探
Dog-Catch 移植了 cat-catch 的核心嗅探技术，提供两层检测机制：

#### 🚀 自动嗅探（启动即检测）
- **完整的 webRequest 监听体系**：
  - **onSendHeaders** - 捕获请求头，存储到 `G.requestHeaders` Map，并进行正则匹配检测
  - **onResponseStarted** - 获取响应头，关联请求头数据，进行完整的资源类型判断
  - **onErrorOccurred** - 清理失败请求的缓存数据，防止内存泄漏
- **Service Worker 生命周期管理**：
  - **心跳保活机制** - 通过 `chrome.runtime.onConnect` 和定时器防止 Service Worker 被强制终止
  - **初始化状态检查** - `G.initSyncComplete` 和 `G.initLocalComplete` 确保配置加载完成
  - **自动重启恢复** - Service Worker 重启后通过 233ms 延迟重试机制恢复检测
- **多层级资源过滤检测**：
  - **URL 路径解析** - `fileNameParse` 函数从 pathname 提取文件名和扩展名
  - **响应头完整解析** - `getResponseHeadersValue` 解析 Content-Type、Content-Length、Content-Disposition、Content-Range

  - **扩展名过滤** - 基于默认扩展名列表（MP4、M3U8、MPD、WebM、FLV、MP3、AAC 等）进行过滤
  - **MIME 类型智能检测** - `CheckType` 支持 video/*、audio/*、application/dash+xml 等类型识别
  - **特殊资源类型处理** - 自动放行 `data.type == "media"` 的浏览器原生媒体资源
- **资源信息构建**：
  - **基础信息** - name, url, size, ext, type 等资源基本属性
  - **页面信息** - 获取当前页面的 title 和 webUrl

- **高性能去重与缓存机制**：
  - **URL 指纹去重** - `G.urlMap` 使用 Set 数据结构进行 O(1) 去重检查
  - **性能保护** - 超过 500 条记录时自动清空去重缓存，防止内存占用过多
  - **分页面缓存** - 每个页面独立的 `cacheData[tabId]` 数组，最大支持 9999 条记录
  - **智能防抖存储** - 高频检测时延迟 2-5 秒存储，批量处理减少 I/O 操作
- **实时更新与通知机制**：
  - **增量更新** - 新检测到的资源实时添加到缓存数组，触发界面更新
  - **角标实时更新** - `SetIcon` 函数动态更新扩展图标数字，支持 999+ 显示
  - **存储同步** - Session Storage 优先，Local Storage 降级，确保数据持久化
- **错误处理与异常保护**：
  - **特殊页面过滤** - `isSpecialPage` 自动屏蔽 chrome://、moz-extension:// 等特殊协议
  - **异常捕获** - 所有关键函数都有 try-catch 保护，确保单个资源错误不影响整体检测

#### 🔎 深度搜索（手动触发）
- **脚本注入机制** - 通过 `chrome.scripting.executeScript` 注入 `search.js` 到页面主世界（MAIN world）
- **多重 API 劫持技术**：
  - **XMLHttpRequest 劫持** - 重写 `XMLHttpRequest.prototype.open` 监听所有 AJAX 请求和响应
  - **Fetch API 劫持** - 代理 `window.fetch` 捕获现代异步请求中的媒体资源
  - **编码函数劫持** - 劫持 `btoa/atob`、`escape`、`String.fromCharCode` 检测编码的媒体内容
  - **数组操作劫持** - 劫持 `Array.prototype.slice` 检测数组切片中的加密密钥
  - **Worker 构造劫持** - 劫持 `Worker` 构造函数，向 Web Worker 注入检测脚本
- **加密密钥智能检测**：
  - **16字节密钥检测** - 检测 Array[16]、ArrayBuffer(16) 格式的 AES 密钥
  - **32字节密钥检测** - 检测 ArrayBuffer(32) 格式的扩展密钥
  - **Base64密钥检测** - 检测长度为24且以"=="结尾的 Base64 编码密钥
  - **重复扩展检测** - 检测 256/128 字节的重复扩展密钥模式
  - **字符串密钥检测** - 检测32字符长度的字符串密钥
- **媒体内容深度识别**：
  - **M3U8 播放列表** - 识别 "#EXTM3U" 开头的 HLS 播放列表内容
  - **MPD 清单文件** - 识别包含 "urn:mpeg:dash:schema:mpd" 的 DASH 清单
  - **Data URI 解码** - 解码 data: 协议中的 Base64 编码媒体内容
  - **分片 M3U8 重组** - 通过 `String.fromCharCode` 重组分片传输的 M3U8 内容
- **JavaScript 变量递归扫描** - 最大深度10层的对象递归遍历，查找隐藏的媒体 URL
- **特殊平台定制处理** - Vimeo CDN 资源的专项识别和处理算法
- **实时通信机制** - 通过 `postMessage` 将发现的资源和密钥实时发送到后台脚本



### 2. 🎬 Video.js 媒体预览
- **专业播放器框架** - 集成开源 Video.js 框架，基于 HTML5 video 元素的全功能播放器
- **多格式原生支持**：
  - **HLS 流媒体** - 原生支持 HTTP Live Streaming (M3U8) 播放列表
  - **DASH 流媒体** - 支持 Dynamic Adaptive Streaming (MPD) 清单文件
  - **传统格式** - MP4、WebM、OGG 等标准视频格式
  - **音频格式** - MP3、AAC、OGG 等音频文件播放
- **字幕系统**：
  - **WebVTT 标准** - 原生支持 W3C WebVTT 字幕格式
  - **多格式兼容** - 通过插件支持 SRT、ASS 等字幕格式本地加载
  - **字幕控制** - `TextTrack API` 提供字幕显示/隐藏/选择功能
  - **多语言支持** - 支持多语言字幕轨道切换和 BCP 47 语言标签
- **完整播放控制**：
  - **基础控制** - `play()`、`pause()`、`currentTime()`、`duration()` 等 API
  - **音量控制** - `volume()`、`muted()` 音量和静音控制
  - **播放速度** - `playbackRate()` 支持 0.25x 到 4x 变速播放
  - **进度控制** - `seekable()`、`seeking()` 精确进度控制和拖拽
- **全屏与画中画**：
  - **全屏模式** - `requestFullscreen()` 和 `exitFullscreen()` 原生全屏支持
  - **全屏检测** - `supportsFullScreen()` 检测浏览器全屏能力
  - **移动端适配** - 在不支持原生全屏的设备上提供"全窗口模式"
- **高级功能**：
  - **缓冲管理** - `buffered()` 获取缓冲状态和时间范围
  - **错误处理** - `error()` 完善的错误检测和恢复机制

## � 用户界面设计

### 界面设计理念
- **简洁美观** - 采用现代化扁平设计风格，简洁直观的用户界面
- **一致性体验** - 在任何网站和页面环境下保持统一的视觉风格和交互体验
- **响应式布局** - 自适应不同屏幕尺寸，确保在各种设备上的最佳显示效果
- **无侵入性** - 界面元素不干扰原网页内容，可随时隐藏或最小化

### 轻量级 UI 组件库
- **CSS 框架** - 采用轻量级 CSS 框架（如 Tailwind CSS 或 Pure.css）实现快速样式开发
- **图标系统** - 集成 Feather Icons 或 Lucide 等轻量级图标库，提供一致的视觉符号
- **动画效果** - 使用 CSS3 原生动画和过渡效果，避免重型 JavaScript 动画库
- **组件复用** - 构建可复用的 UI 组件（按钮、卡片、列表项等），确保界面一致性

### 界面架构分离
- **MVC 模式** - 严格分离界面展示层（View）与业务逻辑层（Controller）
- **组件化设计** - 将界面拆分为独立的功能组件（资源列表、播放器、工具栏等）
- **事件驱动** - 通过事件系统实现界面与后台逻辑的松耦合通信

### 跨站点一致性方案
- **Shadow DOM 隔离** - 使用 Shadow DOM 技术隔离样式，防止网站 CSS 干扰
- **CSS 作用域** - 所有样式使用唯一前缀或 CSS-in-JS 方案，避免样式冲突
- **字体回退** - 使用系统字体栈，确保在任何环境下的字体显示一致性

### 核心界面组件
- **资源列表面板** - 展示检测到的媒体资源，支持按文件类型筛选
- **资源预览系统** - 提供两种预览模式：
  - **简单预览** - 在资源卡片中点击预览按钮，展开卡片内的小窗口，使用简单播放器在卡片中直接播放
  - **详细预览** - 点击播放按钮，单独打开新网页，使用完整的 Video.js 播放器，支持文档中描述的全部功能（多格式支持、字幕系统、完整播放控制、全屏画中画、键盘交互、高级功能等）
- **工具栏** - 包含深度搜索、设置功能按钮的操作工具栏

### 交互体验优化
- **加载反馈** - 提供加载动画和进度指示，优化等待体验
- **错误处理** - 友好的错误提示和恢复建议，提升用户体验

### 插件操作控制
- **打开插件** - 点击浏览器扩展栏中的 Dog-Catch 图标打开插件界面
- **关闭插件** - 点击插件界面右上角的关闭按钮
- **固定显示** - 支持将插件界面固定在页面上，不随页面滚动而移动
- **浮动模式** - 插件界面可以浮动显示，支持拖拽到页面任意位置
- **最小化** - 支持将插件界面最小化为小图标，节省页面空间

### 移动端支持
- **资源查看** - 移动端优化的资源列表界面，支持触摸滚动浏览
- **媒体预览** - Video.js 移动端播放器，支持触摸控制和全屏播放

## �🏗️ 技术架构

### 前端技术栈
- **JavaScript ES6+** - 现代化 JavaScript 语法
- **CSS3** - 响应式设计和动画效果
- **HTML5** - 语义化标记和现代 Web API

### 浏览器扩展技术
- **Manifest V3** - 最新的扩展规范
- **Service Worker** - 后台服务和网络监听
- **Content Scripts** - 页面内容操作和资源注入
- **webRequest API** - 网络请求拦截和分析
- **Storage API** - 本地数据存储和配置管理

### 核心依赖
- **Video.js** - 开源 HTML5 视频播放器框架
- **Video.js HLS** - HLS 流媒体支持插件
- **Video.js DASH** - DASH 流媒体支持插件

## 🚀 功能特性

### 资源检测特性
- ✅ 实时网络监听
- ✅ 多线程并发检测
- ✅ 智能资源分类
- ✅ 文件大小和时长识别
- ✅ 资源质量评估
- ✅ 批量导出功能

### 媒体预览特性
- ✅ 即时预览播放
- ✅ 自适应播放器界面
- ✅ 多种播放模式
- ✅ 播放历史记录
- ✅ 收藏和标签管理
- ✅ 播放统计分析

## 📦 安装使用

### 开发环境要求
- Chrome 浏览器 88+ 版本
- 开发者模式已启用
- Node.js 16+ (用于构建工具)

### 安装步骤
1. 克隆项目到本地
2. 在 Chrome 中打开扩展管理页面 (`chrome://extensions/`)
3. 启用"开发者模式"
4. 点击"加载已解压的扩展程序"
5. 选择项目根目录

## 🔧 开发计划

### 第一阶段：总体架构设计 🏗️
- [ ] 设计 MVC 架构模式和模块划分
- [ ] 创建 manifest.json 配置文件
- [ ] 搭建 Service Worker 后台服务（Controller 层）
- [ ] 建立消息通信机制和事件系统
- [ ] 实现基础的 Content Script 注入框架
- [ ] 定义数据模型和接口规范（Model 层）
- [ ] 设计界面组件架构（View 层）

### 第二阶段：数据层开发 (Model) 📊
**⚠️ 严格移植 cat-catch 成熟做法，禁止自主实现**
**📋 按照"## 🎯 核心功能"中的技术规范实现**
- [ ] 移植 cat-catch 的资源数据模型（name, url, size, ext, type, tabId, requestId, getTime）
- [ ] 复用 cat-catch 的缓存机制（`G.urlMap` Set结构去重、`cacheData[tabId]` 分页面缓存）
- [ ] 移植 cat-catch 的存储同步机制（Session Storage 优先，Local Storage 降级）
- [ ] 复用 cat-catch 的性能保护机制（500条记录清空缓存、最大9999条记录限制）
- [ ] 移植 cat-catch 的智能防抖存储（2-5秒延迟存储，批量处理减少I/O）

### 第三阶段：自动嗅探功能 🔍
**⚠️ 严格移植 cat-catch 成熟做法，禁止自主实现**
- 按照"## 🎯 核心功能 → 🚀 自动嗅探（启动即检测）"中的技术规范实现**


### 第四阶段：深度搜索功能 🔎
**⚠️ 严格移植 cat-catch 成熟做法，禁止自主实现**
- 按照"## 🎯 核心功能 → 深度搜索（手动触发）"中的技术规范实现**


### 第五阶段：Video.js 媒体预览 🎬
- [ ] 集成 Video.js 核心框架
- [ ] 配置多格式支持（HLS、DASH、传统格式、音频格式）
- [ ] 实现字幕系统（WebVTT、多格式兼容、TextTrack API、多语言支持）
- [ ] 开发完整播放控制（基础控制、音量控制、播放速度、进度控制）
- [ ] 添加全屏与画中画功能
- [ ] 集成键盘交互与无障碍支持

### 第六阶段：界面层开发 (View) 🎨
- [ ] 实现资源列表面板（展示检测资源、按文件类型筛选）
- [ ] 集成 Video.js 播放器界面
- [ ] 开发工具栏（深度搜索、设置功能按钮）
- [ ] 实现插件操作控制（打开、关闭、固定、浮动、最小化）
- [ ] 添加移动端支持（资源查看、媒体预览）

### 第七阶段：界面完善优化 ✨
- [ ] 实现跨站点一致性（Shadow DOM 隔离、CSS 作用域、字体回退）
- [ ] 集成轻量级 UI 组件（CSS 框架、图标系统、动画效果）
- [ ] 优化组件化设计和事件驱动机制
- [ ] 完善加载反馈和错误处理

### 第八阶段：测试与发布 🧪
- [ ] 功能测试和 Bug 修复
- [ ] 性能优化和内存管理
- [ ] 兼容性测试
- [ ] 用户体验优化

## 📄 许可证

MIT License - 详见 LICENSE 文件

## 🤝 贡献指南

欢迎提交 Issue 和 Pull Request 来帮助改进项目！

---

**开发状态**: 🚧 正在开发中
**当前版本**: v0.1.0-dev
**最后更新**: 2025-08-09
