# 生产部署配置修改清单

本文档汇总了将项目部署到生产环境前需要完成的配置修改与步骤，便于在根目录一次性查阅与执行。

---

## 一、必须修改的配置文件

1) 前台播放器配置：frontend/public/config.js

示例（请按生产环境实际值修改）：

```js
window.PLAYER_CONFIG = {
  API_BASE_URL: 'https://api.example.com',      // 改为生产环境后端 API 地址
  SUBTITLE_NEED_LOGIN: true,
  ALLOW_PLAY_WITHOUT_LOGIN: true,
  CAPTCHA_SITE_KEY: '你的生产环境验证码site_key', // 改为生产环境验证码 Site Key
  I18N: {
    resend: '获取验证码',
    sentWithCountdown: (s) => `已发送(${s}s)`,
    resendAfter: '重新发送'
  }
};
```

2) 管理后台环境变量：admin/.env.production

```ini
VITE_API_BASE_URL=https://api.example.com
```

3) Userscript 播放器地址：userscript/dog-catch-mobile.user.js

将播放器跳转地址从本地环境：

```js
const playerUrl = `http://localhost:3000/?${new URLSearchParams({ /* ... */ }).toString()}`;
```

修改为生产环境地址（例如）：

```js
const playerUrl = `https://player.example.com/?${new URLSearchParams({ /* ... */ }).toString()}`;
```

4) 后端运行环境变量（在服务器上配置，而非代码内硬编码）

- CORS_ORIGINS：设置为生产环境前端域名白名单（含协议与端口），例如 `https://player.example.com,https://admin.example.com`
- JWT_SECRET：生产环境随机、高强度密钥
- REDIS_URL：生产环境 Redis 连接串，如 `redis://:password@host:6379/0`
- CAPTCHA_*：生产环境验证码配置（如 `CAPTCHA_PROVIDER`、`CAPTCHA_SITE_KEY`、`CAPTCHA_SECRET_KEY` 等）
- SMTP_*：生产环境邮件服务配置（如 `SMTP_HOST`、`SMTP_PORT`、`SMTP_USER`、`SMTP_PASS`、`SMTP_FROM`）
- WATERMARK_*（如项目需要水印功能）：水印文本、样式等
- NODE_ENV=production
- PORT：后端实际监听端口（由 Nginx 反向代理）

---

## 二、部署流程中的修改步骤

1) 替换所有示例域名
- 将文档与配置中的 `your-domain.com`、`api.your-domain.com`、`player.your-domain.com`、`admin.your-domain.com` 等示例域名替换为实际生产域名。

2) 前端构建前修改配置
- 确认 `frontend/public/config.js` 的 `API_BASE_URL` 与 `CAPTCHA_SITE_KEY` 为生产值。
- 管理后台在 `admin/.env.production` 设置 `VITE_API_BASE_URL` 为生产 API 地址，然后执行 `npm ci && npm run build`。

3) Userscript 发布前更新
- 将 `dog-catch-mobile.user.js` 中播放器 URL 切换为生产的 `https://player.example.com`。

4) 服务器环境变量配置
- 在进程管理器（如 PM2/Systemd）或部署脚本中设置上述后端环境变量，确保不在仓库中提交任何密钥信息。

5) 验证关键功能
- 登录/注册/邮件验证码、字幕上传下载与去重、HLS 播放代理、限流与风控命中、后台管理操作、日志与错误监控等。

---

## 三、代码本身的优化与校验项（已具备/建议核对）

- 安全响应头（Helmet）
- CORS 白名单控制
- 文件上传大小限制与类型白名单（.srt/.vtt/.ass/.ssa）
- JWT 认证与限流机制
- 缓存控制策略（no-cache/no-store 针对敏感/字幕接口）
- 配置通过环境变量外部化

以上项在当前代码中已具备基础实现，生产部署时主要是完成配置适配与环境变量设置。

---

## 四、快速检查清单（Checklist）

- [ ] 前端播放器 API_BASE_URL、CAPTCHA_SITE_KEY 已替换为生产值
- [ ] 管理后台 VITE_API_BASE_URL 已指向生产 API
- [ ] Userscript 播放器 URL 已指向生产域名
- [ ] 后端环境变量（JWT/CORS/REDIS/CAPTCHA/SMTP/WATERMARK/NODE_ENV/PORT）已配置
- [ ] Nginx 反向代理与 HTTPS 证书已生效
- [ ] 功能与性能验收通过

---

如需我将以上配置直接改写为你的正式域名与环境值，请提供具体域名与各项密钥/连接信息（敏感信息请通过安全方式传递，不要提交到仓库）。