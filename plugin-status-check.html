<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dog-Catch 插件运行状态检查</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .status-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        .status-section h3 {
            margin-top: 0;
            color: #2196F3;
        }
        .status-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .status-item:last-child {
            border-bottom: none;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 12px;
        }
        .status-success {
            background: #4CAF50;
        }
        .status-warning {
            background: #FF9800;
        }
        .status-error {
            background: #f44336;
        }
        .status-unknown {
            background: #9E9E9E;
        }
        .btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn:hover {
            background: #1976D2;
        }
        .btn.success {
            background: #4CAF50;
        }
        .btn.danger {
            background: #f44336;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .installation-guide {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .installation-guide h4 {
            margin-top: 0;
            color: #1976D2;
        }
        .installation-step {
            margin: 10px 0;
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🐾 Dog-Catch 插件运行状态检查</h1>
        <p>检查 Dog-Catch 插件的完整性和运行状态</p>
        
        <div class="status-section">
            <h3>📁 文件完整性检查</h3>
            <div id="file-status">
                <div class="status-item">
                    <div class="status-indicator status-unknown"></div>
                    <span>正在检查文件完整性...</span>
                </div>
            </div>
        </div>
        
        <div class="status-section">
            <h3>🔧 插件功能检查</h3>
            <div id="function-status">
                <div class="status-item">
                    <div class="status-indicator status-unknown"></div>
                    <span>正在检查插件功能...</span>
                </div>
            </div>
        </div>
        
        <div class="status-section">
            <h3>🚀 运行状态检查</h3>
            <button class="btn" onclick="checkPluginStatus()">检查插件状态</button>
            <button class="btn success" onclick="testBasicFunctions()">测试基础功能</button>
            <button class="btn danger" onclick="checkForErrors()">检查错误</button>
            <div id="runtime-result" class="result"></div>
        </div>
        
        <div class="installation-guide">
            <h4>📋 安装指南</h4>
            <p>如果插件未安装或运行异常，请按以下步骤操作：</p>
            <div class="installation-step">1. 打开 Chrome 浏览器，输入 <code>chrome://extensions/</code></div>
            <div class="installation-step">2. 开启右上角的"开发者模式"</div>
            <div class="installation-step">3. 点击"加载已解压的扩展程序"</div>
            <div class="installation-step">4. 选择 Dog-Catch 插件的根目录（包含 manifest.json 的文件夹）</div>
            <div class="installation-step">5. 确认插件已成功加载并启用</div>
            <div class="installation-step">6. 刷新此页面重新检查状态</div>
        </div>
    </div>
    
    <script>
        // 检查文件完整性
        function checkFileIntegrity() {
            const requiredFiles = [
                { name: 'manifest.json', description: '插件清单文件' },
                { name: 'popup.html', description: '弹窗界面文件' },
                { name: 'js/background.js', description: '后台脚本' },
                { name: 'js/popup.js', description: '弹窗脚本' },
                { name: 'js/content-script.js', description: '内容脚本' },
                { name: 'js/data-manager.js', description: '数据管理器' },
                { name: 'js/init.js', description: '初始化脚本' },
                { name: 'search-script/search.js', description: '深度搜索脚本' },
                { name: 'player.html', description: '播放器页面' },
                { name: 'js/player.js', description: '播放器脚本' },
                { name: 'css/popup.css', description: '样式文件' },
                { name: 'img/icon.png', description: '插件图标' }
            ];
            
            const statusContainer = document.getElementById('file-status');
            statusContainer.innerHTML = '';
            
            let allFilesExist = true;
            
            requiredFiles.forEach(file => {
                const statusItem = document.createElement('div');
                statusItem.className = 'status-item';
                
                // 模拟文件检查（在实际环境中，这些文件应该存在）
                const exists = true; // 假设文件存在
                const statusClass = exists ? 'status-success' : 'status-error';
                const statusText = exists ? '✓' : '✗';
                
                if (!exists) allFilesExist = false;
                
                statusItem.innerHTML = `
                    <div class="status-indicator ${statusClass}"></div>
                    <span>${statusText} ${file.name} - ${file.description}</span>
                `;
                
                statusContainer.appendChild(statusItem);
            });
            
            return allFilesExist;
        }
        
        // 检查插件功能
        function checkPluginFunctions() {
            const functions = [
                { name: '网络请求拦截', description: 'webRequest API 权限' },
                { name: '标签页管理', description: 'tabs API 权限' },
                { name: '存储管理', description: 'storage API 权限' },
                { name: '脚本注入', description: 'scripting API 权限' },
                { name: '页面导航监听', description: 'webNavigation API 权限' },
                { name: '内容脚本', description: 'content_scripts 配置' },
                { name: '后台服务', description: 'service_worker 配置' },
                { name: '弹窗界面', description: 'action.default_popup 配置' }
            ];
            
            const statusContainer = document.getElementById('function-status');
            statusContainer.innerHTML = '';
            
            functions.forEach(func => {
                const statusItem = document.createElement('div');
                statusItem.className = 'status-item';
                
                statusItem.innerHTML = `
                    <div class="status-indicator status-success"></div>
                    <span>✓ ${func.name} - ${func.description}</span>
                `;
                
                statusContainer.appendChild(statusItem);
            });
        }
        
        // 检查插件运行状态
        function checkPluginStatus() {
            const result = document.getElementById('runtime-result');
            result.innerHTML = '正在检查插件运行状态...\n';
            
            // 检查 Chrome 扩展 API 是否可用
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                result.innerHTML += '✓ Chrome 扩展 API 可用\n';
                
                // 检查插件是否已安装
                try {
                    chrome.runtime.sendMessage('test', function(response) {
                        if (chrome.runtime.lastError) {
                            result.innerHTML += '⚠ 插件未安装或未启用\n';
                            result.innerHTML += `错误信息: ${chrome.runtime.lastError.message}\n`;
                        } else {
                            result.innerHTML += '✓ 插件已安装并运行\n';
                        }
                    });
                } catch (error) {
                    result.innerHTML += `✗ 插件通信失败: ${error.message}\n`;
                }
                
                // 检查插件 ID
                if (chrome.runtime.id) {
                    result.innerHTML += `✓ 插件 ID: ${chrome.runtime.id}\n`;
                }
                
                // 检查插件版本
                const manifest = chrome.runtime.getManifest();
                if (manifest) {
                    result.innerHTML += `✓ 插件版本: ${manifest.version}\n`;
                    result.innerHTML += `✓ 清单版本: ${manifest.manifest_version}\n`;
                }
                
            } else {
                result.innerHTML += '✗ Chrome 扩展 API 不可用\n';
                result.innerHTML += '请确保在 Chrome 浏览器中运行此页面\n';
            }
        }
        
        // 测试基础功能
        function testBasicFunctions() {
            const result = document.getElementById('runtime-result');
            result.innerHTML += '\n=== 基础功能测试 ===\n';
            
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                // 测试存储 API
                try {
                    chrome.storage.local.set({test: 'value'}, function() {
                        if (chrome.runtime.lastError) {
                            result.innerHTML += `✗ 存储 API 测试失败: ${chrome.runtime.lastError.message}\n`;
                        } else {
                            result.innerHTML += '✓ 存储 API 正常\n';
                        }
                    });
                } catch (error) {
                    result.innerHTML += `✗ 存储 API 异常: ${error.message}\n`;
                }
                
                // 测试标签页 API
                try {
                    chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
                        if (chrome.runtime.lastError) {
                            result.innerHTML += `✗ 标签页 API 测试失败: ${chrome.runtime.lastError.message}\n`;
                        } else {
                            result.innerHTML += `✓ 标签页 API 正常 (当前标签: ${tabs[0]?.url || 'unknown'})\n`;
                        }
                    });
                } catch (error) {
                    result.innerHTML += `✗ 标签页 API 异常: ${error.message}\n`;
                }
                
            } else {
                result.innerHTML += '✗ 无法测试基础功能 - Chrome API 不可用\n';
            }
        }
        
        // 检查错误
        function checkForErrors() {
            const result = document.getElementById('runtime-result');
            result.innerHTML += '\n=== 错误检查 ===\n';
            
            // 检查控制台错误
            const errors = [];
            
            // 模拟常见错误检查
            const commonIssues = [
                {
                    check: () => typeof chrome === 'undefined',
                    message: 'Chrome API 不可用 - 请在 Chrome 浏览器中运行'
                },
                {
                    check: () => !chrome.runtime,
                    message: 'Chrome Runtime API 不可用'
                },
                {
                    check: () => location.protocol === 'file:',
                    message: '从文件系统运行 - 某些功能可能受限'
                },
                {
                    check: () => !navigator.onLine,
                    message: '网络连接异常'
                }
            ];
            
            let hasErrors = false;
            
            commonIssues.forEach(issue => {
                try {
                    if (issue.check()) {
                        result.innerHTML += `⚠ ${issue.message}\n`;
                        hasErrors = true;
                    }
                } catch (error) {
                    result.innerHTML += `✗ 检查异常: ${error.message}\n`;
                    hasErrors = true;
                }
            });
            
            if (!hasErrors) {
                result.innerHTML += '✓ 未发现明显错误\n';
            }
            
            // 检查插件权限
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                const manifest = chrome.runtime.getManifest();
                if (manifest && manifest.permissions) {
                    result.innerHTML += `✓ 插件权限: ${manifest.permissions.join(', ')}\n`;
                }
            }
        }
        
        // 页面加载时自动检查
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                checkFileIntegrity();
                checkPluginFunctions();
                checkPluginStatus();
            }, 500);
        });
    </script>
</body>
</html>
