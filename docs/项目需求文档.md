# M3U8视频播放器 + 字幕管理系统 需求文档

## 📋 项目概述

### 项目背景
为 https://missav.live 网站用户提供更好的视频观看体验，通过油猴脚本检测视频资源，跳转到自建播放器进行播放，并提供自动字幕功能。

### 项目目标
- 提供专业的M3U8视频播放体验
- 支持多清晰度选择
- 自动加载字幕文件
- 便捷的字幕管理后台

## 🏗️ 系统架构

```
油猴脚本 → 前端播放器 → 后端API → 后台管理系统
    ↓           ↓           ↓           ↓
 资源嗅探    播放器界面    字幕API    字幕文件管理
```

## 🎬 前端播放器需求

### 1.1 播放器页面
**功能描述**：提供专业的视频播放界面

**具体需求**：
- YouTube风格的响应式播放器界面
- 16:9宽高比，支持多种屏幕尺寸
- 使用Video.js实现M3U8视频播放
- 支持播放控制（播放/暂停/进度条/音量/全屏）
- 移动端适配，支持触摸操作

**技术要求**：
- 纯HTML/CSS/JavaScript实现
- 使用Video.js播放器框架（内置VHS插件支持HLS）
- 响应式设计，兼容PC和移动端

### 1.2 Master Playlist处理
**功能描述**：解析playlist.m3u8文件，提供清晰度选择

**输入参数**：
```
?src=https://surrit.com/.../playlist.m3u8
&referer=https://missav.live/...
&video=hmn-387
```

**具体需求**：
- 自动获取并解析playlist.m3u8文件
- 提取所有可用清晰度（720p、1080p等）
- 显示清晰度选择按钮
- 默认选择中等清晰度
- 支持播放中切换清晰度

### 1.3 字幕系统
**功能描述**：自动加载并显示字幕

**具体需求**：
- 从URL中自动提取视频编号（如hmn-387）
- 向后端API请求对应的字幕文件
- 支持SRT格式字幕，自动转换为WebVTT
- 字幕显示样式可调整（大小、颜色、位置）
- 提供字幕开关控制

## 🔧 后端API需求

### 2.1 API接口设计

**字幕相关接口**：
```
GET  /api/subtitle/{video_id}     # 获取字幕文件
POST /api/subtitle/{video_id}     # 上传字幕文件（需认证）
PUT  /api/subtitle/{video_id}     # 更新字幕文件（需认证）
DELETE /api/subtitle/{video_id}   # 删除字幕文件（需认证）
GET  /api/subtitles               # 获取字幕列表（需认证）
```

**认证相关接口**：
```
POST /api/auth/login              # 管理员登录
POST /api/auth/logout             # 管理员登出
GET  /api/auth/verify             # 验证token有效性
```

### 2.2 字幕服务
**功能描述**：提供字幕文件的存储和检索服务

**具体需求**：
- 支持SRT、VTT格式字幕文件
- 文件存储（本地文件系统或云存储）
- 文件大小限制（单个文件不超过1MB）
- 支持文件压缩和缓存
- 设置适当的CORS头支持跨域请求

### 2.3 用户认证
**功能描述**：管理员身份验证和权限控制

**具体需求**：
- 基于JWT的身份验证
- 管理员账号密码登录
- Token过期时间控制（24小时）
- 权限中间件保护管理接口

### 2.4 文件管理
**功能描述**：处理字幕文件的上传、存储和管理

**具体需求**：
- 文件上传处理（支持multipart/form-data）
- 文件格式验证（仅允许.srt、.vtt格式）
- 自动文件重命名（按视频编号）
- 文件存在性检查
- 批量操作支持

## 🎛️ 后台管理系统需求

### 3.1 登录页面
**功能描述**：管理员登录界面

**具体需求**：
- 简洁的登录表单（用户名、密码）
- 记住登录状态（localStorage）
- 登录失败提示
- 响应式设计

### 3.2 字幕管理主界面
**功能描述**：字幕文件管理的主要操作界面

**界面布局**：
```
┌─────────────────────────────────────┐
│ 字幕文件管理系统                      │
├─────────────────────────────────────┤
│ [上传字幕] [批量上传] [搜索: ___] [导出] │
├─────────────────────────────────────┤
│ 视频编号    │ 字幕状态 │ 操作            │
│ hmn-387    │ ✅已上传 │ [预览][更新][删除] │
│ jufd-924   │ ❌缺失   │ [上传]          │
│ ssis-123   │ ✅已上传 │ [预览][更新][删除] │
└─────────────────────────────────────┘
```

**具体需求**：
- 表格形式显示所有视频编号和字幕状态
- 支持分页显示（每页50条）
- 实时状态更新
- 操作按钮：上传、预览、更新、删除

### 3.3 文件上传功能
**功能描述**：支持单个和批量字幕文件上传

**具体需求**：
- 单文件上传：通过文件对话框选择文件
- 批量上传：支持ZIP文件，自动解压并识别视频编号
- 上传进度显示
- 文件格式验证
- 上传成功/失败提示
- 自动刷新列表

### 3.4 字幕文件更新功能
**功能描述**：更新已上传的字幕文件

**具体需求**：
- 针对已上传字幕的视频提供"更新"按钮
- 点击更新按钮弹出文件选择对话框
- 更新前显示当前字幕文件信息（文件大小、上传时间）
- 更新确认提示，避免误操作
- 保留字幕文件版本历史（可选功能）
- 更新成功后自动刷新列表和状态

### 3.5 搜索与筛选
**功能描述**：快速查找和筛选字幕文件

**具体需求**：
- 按视频编号搜索（支持模糊匹配）
- 按字幕状态筛选：全部/已有/缺失
- 按上传时间排序
- 搜索结果实时更新

### 3.6 批量管理功能
**功能描述**：提高管理效率的批量操作

**具体需求**：
- 批量删除选中的字幕文件
- 导出字幕列表为CSV格式
- 数据统计显示：
  - 总视频数量
  - 已有字幕数量
  - 缺失字幕数量
  - 完成度百分比

## 🔄 系统工作流程

### 4.1 用户观看流程
1. **资源发现**：油猴脚本在missav.live检测到playlist.m3u8
2. **跳转播放**：点击"播放"按钮跳转到自建播放器
3. **清晰度选择**：播放器解析playlist显示清晰度选项
4. **自动字幕**：根据视频编号请求字幕并自动加载
5. **开始观看**：用户选择清晰度后开始播放

### 4.2 管理员管理流程
1. **登录后台**：管理员登录后台管理系统
2. **查看列表**：查看所有视频的字幕状态
3. **上传字幕**：为缺失字幕的视频上传对应的.srt文件
4. **批量管理**：批量处理多个字幕文件
5. **数据导出**：导出管理数据用于备份

## 💻 技术栈要求

### 5.1 前端播放器
- **基础技术**：HTML5 + CSS3 + JavaScript ES6+
- **视频播放**：Video.js库（内置VHS插件）
- **UI框架**：原生CSS，响应式设计
- **兼容性**：Chrome 70+, Firefox 65+, Safari 12+

### 5.2 后台管理系统
- **框架**：Vue.js 3.x
- **UI组件库**：Element Plus
- **文件上传**：Vue-Upload-Component
- **状态管理**：Vuex 4.x
- **路由管理**：Vue Router 4.x

### 5.3 后端服务
- **运行环境**：Node.js 16+ 或 Python 3.8+
- **Web框架**：Express.js 或 FastAPI
- **数据库**：SQLite（开发）/ PostgreSQL（生产）
- **认证**：JWT
- **文件存储**：本地文件系统

## 🚀 部署要求

### 6.1 开发环境
- **前端**：本地开发服务器（Vite/Webpack）
- **后端**：本地Node.js/Python服务
- **数据库**：本地SQLite

### 6.2 生产环境
- **前端部署**：Vercel / Netlify（静态托管）
- **后端部署**：Railway / Heroku / VPS
- **数据库**：托管PostgreSQL服务
- **域名**：自定义域名，HTTPS证书

## 📊 性能要求

### 7.1 播放器性能
- 视频加载时间：< 3秒
- 清晰度切换：< 1秒
- 字幕加载：< 500ms
- 页面响应时间：< 200ms

### 7.2 后台管理性能
- 页面加载时间：< 2秒
- 文件上传：支持最大10MB文件
- 批量操作：支持最多100个文件
- 并发用户：支持5个管理员同时操作

## 🔒 安全要求

### 8.1 数据安全
- 管理员密码加密存储
- JWT Token安全配置
- 文件上传安全验证
- SQL注入防护

### 8.2 访问控制
- 管理接口需要身份验证
- CORS配置限制来源域名
- 文件访问权限控制
- API访问频率限制

## 🔧 当前脚本修改方案

### 10.1 油猴脚本修改
**功能描述**：修改现有的 `dog-catch-mobile.user.js` 脚本，使其跳转到自建播放器

**具体修改**：
1. **添加 openPlayer 方法**
   ```javascript
   openPlayer(videoUrl, videoType = 'auto', title = '') {
       // 自动判断视频类型
       if (videoType === 'auto') {
           videoType = videoUrl.includes('.m3u8') ? 'hls' : 'mp4';
       }
       
       // 提取视频编号（从当前页面URL）
       const videoId = this.extractVideoId(location.href);
       
       // 跳转到自建播放器
       const playerUrl = `https://your-domain.com/player?${new URLSearchParams({
           src: videoUrl,
           type: videoType,
           title: title || '',
           referer: location.href,
           video: videoId || ''
       }).toString()}`;
       
       this.openInTab(playerUrl);
   }
   ```

2. **添加视频编号提取方法**
   ```javascript
   extractVideoId(url) {
       // 从 missav.live URL 中提取视频编号
       // 例如：https://missav.live/cn/hmn-387-uncensored-leak → hmn-387
       const match = url.match(/\/([a-z0-9]+-[0-9]+)/i);
       return match ? match[1] : null;
   }
   ```

3. **修改现有下载回调**
   - 将 MP4 和 M3U8 的 `download()` 回调改为调用 `openPlayer` 方法
   - 保持现有的资源嗅探功能不变

**修改位置**：
- 在 `mgmapi` 对象中添加新方法
- 修改 `showVideo` 函数中的 `download` 回调
- 保持其他功能（资源嗅探、UI显示等）完全不变

## 📁 项目文件组织结构

### 11.1 整体目录结构
```
project-root/
├── userscript/                 # 油猴脚本目录
│   ├── dog-catch-mobile.user.js    # 修改后的油猴脚本
│   └── README.md               # 脚本使用说明
├── frontend/                   # 前端播放器目录
│   ├── public/                 # 静态资源
│   ├── src/                    # 源代码
│   ├── dist/                   # 构建输出
│   └── package.json            # 前端依赖
├── backend/                    # 后端服务目录
│   ├── src/                    # 源代码
│   ├── uploads/                # 字幕文件存储
│   ├── database/               # 数据库文件
│   └── package.json            # 后端依赖
├── admin/                      # 后台管理系统目录
│   ├── public/                 # 静态资源
│   ├── src/                    # 源代码
│   ├── dist/                   # 构建输出
│   └── package.json            # 管理系统依赖
├── docs/                       # 文档目录
│   ├── 项目需求文档.md          # 当前文档
│   ├── API文档.md              # API接口文档
│   └── 部署文档.md             # 部署说明
├── docker/                     # Docker配置（可选）
│   ├── Dockerfile.backend      # 后端Docker文件
│   ├── Dockerfile.frontend     # 前端Docker文件
│   └── docker-compose.yml      # 容器编排
└── README.md                   # 项目总体说明
```

### 11.2 各目录职责说明

#### userscript/ - 油猴脚本
- **作用**：资源嗅探和跳转功能
- **部署**：用户手动安装到Tampermonkey
- **依赖**：无（纯JavaScript）

#### frontend/ - 前端播放器
- **作用**：视频播放界面，处理M3U8解析和播放
- **技术栈**：HTML + CSS + JavaScript + Video.js
- **部署**：静态文件部署到CDN或静态托管服务
- **访问方式**：`https://your-domain.com/player`

#### backend/ - 后端API服务
- **作用**：提供字幕文件API和用户认证
- **技术栈**：Node.js + Express 或 Python + FastAPI
- **部署**：服务器或云平台（Heroku/Railway等）
- **访问方式**：`https://api.your-domain.com`

#### admin/ - 后台管理系统
- **作用**：字幕文件管理界面
- **技术栈**：Vue.js + Element Plus
- **部署**：静态文件部署，独立域名或子路径
- **访问方式**：`https://admin.your-domain.com` 或 `https://your-domain.com/admin`

### 11.3 开发和部署流程

#### 开发阶段
1. **本地开发**：各模块在对应目录下独立开发
2. **联调测试**：使用本地服务进行前后端联调
3. **脚本测试**：修改油猴脚本指向本地开发服务器

#### 部署阶段
1. **后端先行**：部署后端API服务，获得API地址
2. **前端配置**：配置前端指向正式API地址，构建部署
3. **管理系统**：配置管理系统指向正式API，构建部署
4. **脚本更新**：修改油猴脚本指向正式播放器地址
5. **域名配置**：配置自定义域名和HTTPS证书

### 11.4 环境配置说明

#### 开发环境
```
Frontend:  http://localhost:3000
Backend:   http://localhost:8000
Admin:     http://localhost:3001
```

#### 生产环境
```
Frontend:  https://player.your-domain.com
Backend:   https://api.your-domain.com
Admin:     https://admin.your-domain.com
```

**注意事项**：
- 各模块保持相对独立，便于单独开发和部署
- 前端和管理系统可以共享部分组件和样式
- 后端API需要支持CORS，允许前端和管理系统跨域访问
- 字幕文件存储可以使用本地文件系统或云存储服务

## 📝 开发计划

### Phase 1：基础功能（4周）
- 修改油猴脚本，添加跳转功能
- 前端播放器开发
- 后端字幕API开发
- 基础的后台管理界面

### Phase 2：完善功能（2周）
- 批量管理功能
- 搜索筛选功能
- 性能优化

### Phase 3：部署上线（1周）
- 生产环境部署
- 域名配置
- 测试验收

## 📋 验收标准

### 9.1 功能验收
- [ ] 播放器能正常播放M3U8视频
- [ ] 支持多清晰度选择和切换
- [ ] 字幕能自动加载并正确显示
- [ ] 后台管理系统功能完整
- [ ] 文件上传和管理功能正常

### 9.2 性能验收
- [ ] 满足性能要求指标
- [ ] 移动端适配良好
- [ ] 跨浏览器兼容性测试通过

### 9.3 安全验收
- [ ] 身份验证机制有效
- [ ] 文件上传安全检查
- [ ] 无明显安全漏洞

---

**文档版本**：v1.0 