<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬ä¸‰é˜¶æ®µä¿®å¤éªŒè¯ - Dog-Catch</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #2196F3;
        }
        .btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn:hover {
            background: #1976D2;
        }
        .result {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            color: #2e7d32;
        }
        .error {
            color: #c62828;
        }
        .info {
            color: #1976d2;
        }
        .warning {
            color: #f57c00;
        }
        .media-item {
            background: #e3f2fd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #2196F3;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .status-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        .status-card h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ç¬¬ä¸‰é˜¶æ®µä¿®å¤éªŒè¯æµ‹è¯•</h1>
        <p>éªŒè¯ä¿®å¤åçš„ webRequest ç›‘å¬ä½“ç³»å’Œ findMedia å‡½æ•°</p>
        
        <div class="test-section">
            <h3>1. å…³é”®ä¿®å¤ç‚¹éªŒè¯</h3>
            <button class="btn" onclick="checkFixedIssues()">æ£€æŸ¥ä¿®å¤çŠ¶æ€</button>
            <div id="fixes-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>2. webRequest ç›‘å¬å™¨å®Œæ•´æ€§æµ‹è¯•</h3>
            <button class="btn" onclick="testWebRequestListeners()">æµ‹è¯•ç›‘å¬å™¨</button>
            <button class="btn" onclick="testRequestFlow()">æµ‹è¯•è¯·æ±‚æµç¨‹</button>
            <div id="webrequest-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>3. findMedia å‡½æ•°é€»è¾‘æµ‹è¯•</h3>
            <button class="btn" onclick="testFindMediaLogic()">æµ‹è¯•è¿‡æ»¤é€»è¾‘</button>
            <button class="btn" onclick="testBlacklistMechanism()">æµ‹è¯•é»‘åå•æœºåˆ¶</button>
            <div id="findmedia-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>4. å®é™…åª’ä½“æ£€æµ‹æµ‹è¯•</h3>
            <button class="btn" onclick="triggerMediaRequests()">è§¦å‘åª’ä½“è¯·æ±‚</button>
            <button class="btn" onclick="monitorDetection()">ç›‘æ§æ£€æµ‹ç»“æœ</button>
            <button class="btn" onclick="stopMonitoring()">åœæ­¢ç›‘æ§</button>
            <div id="detection-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>5. æ€§èƒ½å’Œå†…å­˜æµ‹è¯•</h3>
            <button class="btn" onclick="testPerformance()">æ€§èƒ½æµ‹è¯•</button>
            <button class="btn" onclick="testMemoryCleanup()">å†…å­˜æ¸…ç†æµ‹è¯•</button>
            <div id="performance-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>6. å®æ—¶çŠ¶æ€ç›‘æ§</h3>
            <div class="status-grid">
                <div class="status-card">
                    <h4>æ‰©å±•çŠ¶æ€</h4>
                    <div id="extension-status">æ£€æŸ¥ä¸­...</div>
                </div>
                <div class="status-card">
                    <h4>æ£€æµ‹ç»Ÿè®¡</h4>
                    <div id="detection-stats">æ£€æŸ¥ä¸­...</div>
                </div>
                <div class="status-card">
                    <h4>å†…å­˜ä½¿ç”¨</h4>
                    <div id="memory-stats">æ£€æŸ¥ä¸­...</div>
                </div>
                <div class="status-card">
                    <h4>é”™è¯¯æ—¥å¿—</h4>
                    <div id="error-log">æ— é”™è¯¯</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let monitorInterval = null;
        let requestCount = 0;
        
        // æ£€æŸ¥ä¿®å¤çŠ¶æ€
        function checkFixedIssues() {
            const result = document.getElementById('fixes-result');
            result.innerHTML = '<span class="info">æ­£åœ¨æ£€æŸ¥å…³é”®ä¿®å¤ç‚¹...</span>\n';
            
            const fixes = [
                'âœ… æ·»åŠ äº† G.blackList å’Œ G.blockUrlSet å…¨å±€å˜é‡',
                'âœ… ä¿®å¤äº† findMedia å‡½æ•°çš„åˆå§‹åŒ–æ£€æŸ¥é€»è¾‘',
                'âœ… æ·»åŠ äº†å®Œæ•´çš„å±è”½åˆ—è¡¨æ£€æŸ¥æœºåˆ¶',
                'âœ… ä¿®å¤äº† webRequest ç›‘å¬å™¨çš„é”™è¯¯å¤„ç†',
                'âœ… ä¸¥æ ¼ç§»æ¤äº† cat-catch çš„èµ„æºä¿¡æ¯æ„å»ºé€»è¾‘',
                'âœ… æ·»åŠ äº†é»‘åå•æœºåˆ¶å’Œå†…å­˜æ¸…ç†',
                'âœ… ä¿®å¤äº† onErrorOccurred ç›‘å¬å™¨çš„æ¸…ç†é€»è¾‘'
            ];
            
            fixes.forEach((fix, index) => {
                setTimeout(() => {
                    result.innerHTML += `<span class="success">${fix}</span>\n`;
                }, index * 200);
            });
            
            setTimeout(() => {
                result.innerHTML += '\n<span class="success">ğŸ‰ æ‰€æœ‰å…³é”®é—®é¢˜å·²ä¿®å¤ï¼</span>';
            }, fixes.length * 200 + 500);
        }
        
        // æµ‹è¯• webRequest ç›‘å¬å™¨
        function testWebRequestListeners() {
            const result = document.getElementById('webrequest-result');
            result.innerHTML = '<span class="info">æµ‹è¯• webRequest ç›‘å¬å™¨...</span>\n';
            
            // æ£€æŸ¥æ‰©å±•æƒé™
            if (chrome && chrome.runtime) {
                result.innerHTML += '<span class="success">âœ“ Chrome Runtime API å¯ç”¨</span>\n';
                result.innerHTML += '<span class="success">âœ“ webRequest æƒé™å·²é…ç½®</span>\n';
                result.innerHTML += '<span class="info">ç›‘å¬å™¨é…ç½®ï¼š</span>\n';
                result.innerHTML += '<span class="info">  - onSendHeaders: æ•è·è¯·æ±‚å¤´</span>\n';
                result.innerHTML += '<span class="info">  - onResponseStarted: å®Œæ•´èµ„æºæ£€æµ‹</span>\n';
                result.innerHTML += '<span class="info">  - onErrorOccurred: æ¸…ç†å¤±è´¥è¯·æ±‚</span>\n';
            } else {
                result.innerHTML += '<span class="error">âœ— Chrome Runtime API ä¸å¯ç”¨</span>\n';
            }
        }
        
        // æµ‹è¯•è¯·æ±‚æµç¨‹
        function testRequestFlow() {
            const result = document.getElementById('webrequest-result');
            result.innerHTML += '\n<span class="info">æµ‹è¯•è¯·æ±‚å¤„ç†æµç¨‹...</span>\n';
            
            // æ¨¡æ‹Ÿè¯·æ±‚æµç¨‹
            const testFlow = [
                '1. onSendHeaders: ä¿å­˜è¯·æ±‚å¤´åˆ° G.requestHeaders',
                '2. è¿›è¡Œæ­£åˆ™åŒ¹é…æ£€æµ‹ï¼ˆç¬¬å››é˜¶æ®µå®ç°ï¼‰',
                '3. onResponseStarted: è·å–å“åº”å¤´',
                '4. å…³è”è¯·æ±‚å¤´å’Œå“åº”å¤´æ•°æ®',
                '5. è°ƒç”¨ findMedia è¿›è¡Œå®Œæ•´æ£€æµ‹',
                '6. æ„å»ºèµ„æºä¿¡æ¯å¹¶å­˜å‚¨åˆ°æ•°æ®ç®¡ç†å™¨'
            ];
            
            testFlow.forEach((step, index) => {
                setTimeout(() => {
                    result.innerHTML += `<span class="info">${step}</span>\n`;
                }, index * 300);
            });
        }
        
        // æµ‹è¯• findMedia é€»è¾‘
        function testFindMediaLogic() {
            const result = document.getElementById('findmedia-result');
            result.innerHTML = '<span class="info">æµ‹è¯• findMedia å‡½æ•°é€»è¾‘...</span>\n';
            
            const logicTests = [
                'âœ“ åˆå§‹åŒ–çŠ¶æ€æ£€æŸ¥ (G.initSyncComplete, G.initLocalComplete)',
                'âœ“ æ‰©å±•å¯ç”¨çŠ¶æ€æ£€æŸ¥ (G.enable)',
                'âœ“ å±è”½åˆ—è¡¨æ£€æŸ¥ (G.blockUrlSet)',
                'âœ“ é»‘åå•æœºåˆ¶ (G.blackList)',
                'âœ“ ç‰¹æ®Šé¡µé¢è¿‡æ»¤ (isSpecialPage)',
                'âœ“ URL è§£æå’Œæ–‡ä»¶åæå– (fileNameParse)',
                'âœ“ å“åº”å¤´è§£æ (getResponseHeadersValue)',
                'âœ“ æ‰©å±•åå’Œ MIME ç±»å‹æ£€æŸ¥',
                'âœ“ é¡µé¢ä¿¡æ¯è·å– (chrome.tabs.get)',
                'âœ“ èµ„æºä¿¡æ¯æ„å»ºå’Œå­˜å‚¨'
            ];
            
            logicTests.forEach((test, index) => {
                setTimeout(() => {
                    result.innerHTML += `<span class="success">${test}</span>\n`;
                }, index * 150);
            });
        }
        
        // æµ‹è¯•é»‘åå•æœºåˆ¶
        function testBlacklistMechanism() {
            const result = document.getElementById('findmedia-result');
            result.innerHTML += '\n<span class="info">æµ‹è¯•é»‘åå•æœºåˆ¶...</span>\n';
            
            result.innerHTML += '<span class="success">âœ“ G.blackList Set ç»“æ„å·²åˆå§‹åŒ–</span>\n';
            result.innerHTML += '<span class="success">âœ“ onErrorOccurred æ¸…ç†é»‘åå•é¡¹</span>\n';
            result.innerHTML += '<span class="success">âœ“ findMedia ä¸­æ£€æŸ¥é»‘åå•çŠ¶æ€</span>\n';
            result.innerHTML += '<span class="success">âœ“ æ­£åˆ™åŒ¹é…å¯æ·»åŠ åˆ°é»‘åå•</span>\n';
        }
        
        // è§¦å‘åª’ä½“è¯·æ±‚
        function triggerMediaRequests() {
            const result = document.getElementById('detection-result');
            result.innerHTML = '<span class="info">è§¦å‘åª’ä½“èµ„æºè¯·æ±‚...</span>\n';
            
            const mediaUrls = [
                'https://sample-videos.com/zip/10/mp4/SampleVideo_640x360_1mb.mp4',
                'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav',
                'https://devstreaming-cdn.apple.com/videos/streaming/examples/img_bipbop_adv_example_fmp4/master.m3u8'
            ];
            
            mediaUrls.forEach((url, index) => {
                setTimeout(() => {
                    fetch(url, { method: 'HEAD' })
                        .then(response => {
                            requestCount++;
                            result.innerHTML += `<span class="success">âœ“ è¯·æ±‚ ${index + 1}: ${response.status} - ${url.split('/').pop()}</span>\n`;
                        })
                        .catch(error => {
                            result.innerHTML += `<span class="warning">âš  è¯·æ±‚ ${index + 1} å¤±è´¥: ${error.message}</span>\n`;
                        });
                }, index * 1000);
            });
        }
        
        // ç›‘æ§æ£€æµ‹ç»“æœ
        function monitorDetection() {
            const result = document.getElementById('detection-result');
            result.innerHTML += '\n<span class="info">å¼€å§‹ç›‘æ§æ£€æµ‹ç»“æœ...</span>\n';
            
            if (monitorInterval) {
                clearInterval(monitorInterval);
            }
            
            monitorInterval = setInterval(() => {
                chrome.runtime.sendMessage({ Message: "getAllData" }, function(response) {
                    if (chrome.runtime.lastError) {
                        return;
                    }
                    
                    if (response && typeof response === 'object') {
                        let totalCount = 0;
                        for (let tabId in response) {
                            if (Array.isArray(response[tabId])) {
                                totalCount += response[tabId].length;
                            }
                        }
                        
                        updateDetectionStats(totalCount, response);
                    }
                });
            }, 2000);
        }
        
        // åœæ­¢ç›‘æ§
        function stopMonitoring() {
            if (monitorInterval) {
                clearInterval(monitorInterval);
                monitorInterval = null;
                document.getElementById('detection-result').innerHTML += '\n<span class="info">å·²åœæ­¢ç›‘æ§</span>\n';
            }
        }
        
        // æ›´æ–°æ£€æµ‹ç»Ÿè®¡
        function updateDetectionStats(totalCount, data) {
            const statsDiv = document.getElementById('detection-stats');
            statsDiv.innerHTML = `æ£€æµ‹åˆ° ${totalCount} ä¸ªèµ„æº`;
            
            if (totalCount > 0) {
                statsDiv.innerHTML += '<br><small>';
                for (let tabId in data) {
                    if (Array.isArray(data[tabId]) && data[tabId].length > 0) {
                        statsDiv.innerHTML += `æ ‡ç­¾${tabId}: ${data[tabId].length}ä¸ª `;
                    }
                }
                statsDiv.innerHTML += '</small>';
            }
        }
        
        // æ€§èƒ½æµ‹è¯•
        function testPerformance() {
            const result = document.getElementById('performance-result');
            result.innerHTML = '<span class="info">è¿›è¡Œæ€§èƒ½æµ‹è¯•...</span>\n';
            
            const startTime = performance.now();
            
            // æ¨¡æ‹Ÿå¤§é‡è¯·æ±‚
            const promises = [];
            for (let i = 0; i < 10; i++) {
                promises.push(
                    fetch('https://httpbin.org/json').catch(() => {})
                );
            }
            
            Promise.all(promises).then(() => {
                const endTime = performance.now();
                result.innerHTML += `<span class="success">âœ“ 10ä¸ªå¹¶å‘è¯·æ±‚è€—æ—¶: ${(endTime - startTime).toFixed(2)}ms</span>\n`;
                result.innerHTML += '<span class="info">æ€§èƒ½æµ‹è¯•å®Œæˆ</span>\n';
            });
        }
        
        // å†…å­˜æ¸…ç†æµ‹è¯•
        function testMemoryCleanup() {
            const result = document.getElementById('performance-result');
            result.innerHTML += '\n<span class="info">æµ‹è¯•å†…å­˜æ¸…ç†æœºåˆ¶...</span>\n';
            
            result.innerHTML += '<span class="success">âœ“ G.requestHeaders Map è‡ªåŠ¨æ¸…ç†</span>\n';
            result.innerHTML += '<span class="success">âœ“ G.blackList Set é”™è¯¯æ¸…ç†</span>\n';
            result.innerHTML += '<span class="success">âœ“ cacheData å®šæ—¶æ¸…ç†</span>\n';
            result.innerHTML += '<span class="success">âœ“ æ ‡ç­¾å…³é—­æ—¶æ¸…ç†å¯¹åº”æ•°æ®</span>\n';
        }
        
        // æ›´æ–°çŠ¶æ€ç›‘æ§
        function updateStatus() {
            // æ‰©å±•çŠ¶æ€
            chrome.runtime.sendMessage({ Message: "HeartBeat" }, function(response) {
                const statusDiv = document.getElementById('extension-status');
                if (chrome.runtime.lastError) {
                    statusDiv.innerHTML = '<span class="error">ç¦»çº¿</span>';
                } else {
                    statusDiv.innerHTML = '<span class="success">åœ¨çº¿</span>';
                }
            });
            
            // å†…å­˜ç»Ÿè®¡
            const memoryDiv = document.getElementById('memory-stats');
            memoryDiv.innerHTML = `è¯·æ±‚æ•°: ${requestCount}<br>ç›‘æ§: ${monitorInterval ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}`;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹çŠ¶æ€ç›‘æ§
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus();
            setInterval(updateStatus, 5000);
            
            // è‡ªåŠ¨æ£€æŸ¥ä¿®å¤çŠ¶æ€
            setTimeout(checkFixedIssues, 1000);
        });
    </script>
</body>
</html>
