<template>
  <div class="dashboard-container">
    <!-- Â§¥ÈÉ® -->
    <div class="header">
      <div class="header-left">
        <span class="main-title">ÁÆ°ÁêÜÁ≥ªÁªü</span>
        <span class="separator">|</span>
        <span class="sub-title">Â≠óÂπï‰∏éÁî®Êà∑ÁÆ°ÁêÜ</span>
      </div>
      <div class="header-right">
        <span class="welcome-text">Ê¨¢ËøéÔºå{{ currentUser.username }}</span>
        <el-button @click="handleLogout" type="danger" plain size="small">
          <el-icon><SwitchButton /></el-icon>
          ÈÄÄÂá∫ÁôªÂΩï
        </el-button>
      </div>
    </div>

    <!-- Ê†áÁ≠æÈ°µ -->
    <el-tabs v-model="activeTab" @tab-click="onTabClick">
      <el-tab-pane label="Â≠óÂπïÁÆ°ÁêÜ" name="subtitles">
        <!-- Â∑•ÂÖ∑Ê†è -->
        <div class="toolbar">
          <div class="toolbar-left">
            <el-button type="primary" @click="openCreateUploadDialog">
              <el-icon><Upload /></el-icon>
              ‰∏ä‰º†Â≠óÂπï
            </el-button>
            <el-button @click="showBatchUploadDialog = true">
              <el-icon><FolderOpened /></el-icon>
              ÊâπÈáè‰∏ä‰º†
            </el-button>
            <el-button @click="exportData" :loading="exporting">
              <el-icon><Download /></el-icon>
              ÂØºÂá∫Êï∞ÊçÆ
            </el-button>
            <el-divider direction="vertical" />
            <el-button @click="selectAllCurrentPage" :disabled="loading || tableData.length === 0">
              ÂÖ®ÈÄâÂΩìÂâçÈ°µ
            </el-button>
            <el-button @click="invertSelection" :disabled="loading || tableData.length === 0">
              ÂèçÈÄâÂΩìÂâçÈ°µ
            </el-button>
            <el-button @click="clearSelection" :disabled="selectedIds.size === 0">
              ÂèñÊ∂àÈÄâÊã©
            </el-button>
            <el-button type="danger" @click="bulkDelete" :loading="deleting" :disabled="selectedIds.size === 0">
              <el-icon><Delete /></el-icon>
              ÊâπÈáèÂà†Èô§
            </el-button>
            <el-button type="danger" @click="deleteAllSubtitles" :loading="deletingAll" plain>
              <el-icon><Delete /></el-icon>
              ÂÖ®ÈÉ®Âà†Èô§
            </el-button>
          </div>
          <div class="toolbar-right">
            <el-input
              v-model="searchQuery"
              placeholder="ÊêúÁ¥¢ËßÜÈ¢ëÁºñÂè∑..."
              prefix-icon="Search"
              style="width: 300px"
              @input="handleSearch"
              clearable
            />
          </div>
        </div>

        <!-- ÁªüËÆ°Âç°Áâá -->
        <div class="stats-cards">
          <el-card class="stat-card">
            <div class="stat-content">
              <div class="stat-number">{{ allStats.total }}</div>
              <div class="stat-label">ÊÄªËßÜÈ¢ëÊï∞</div>
            </div>
            <div class="stat-icon">
              <el-icon><VideoCamera /></el-icon>
            </div>
          </el-card>
          <el-card class="stat-card">
            <div class="stat-content">
              <div class="stat-number">{{ allStats.hasSubtitle }}</div>
              <div class="stat-label">Â∑≤ÊúâÂ≠óÂπï</div>
            </div>
            <div class="stat-icon">
              <el-icon><Document /></el-icon>
            </div>
          </el-card>
          <el-card class="stat-card">
            <div class="stat-content">
              <div class="stat-number">{{ allStats.missing }}</div>
              <div class="stat-label">Áº∫Â§±Â≠óÂπï</div>
            </div>
            <div class="stat-icon">
              <el-icon><Warning /></el-icon>
            </div>
          </el-card>
          <el-card class="stat-card">
            <div class="stat-content">
              <div class="stat-number">{{ allStats.completion }}%</div>
              <div class="stat-label">ÂÆåÊàêÂ∫¶</div>
            </div>
            <div class="stat-icon">
              <el-icon><TrendCharts /></el-icon>
            </div>
          </el-card>
        </div>

        <!-- Êï∞ÊçÆË°®Ê†º -->
        <el-card class="table-card">
          <el-table
            ref="tableRef"
            :data="tableData"
            v-loading="loading"
            style="width: 100%"
            height="400"
            stripe
            @selection-change="onSelectionChange"
          >
            <el-table-column type="selection" width="48" />
            <el-table-column prop="video_id" label="ËßÜÈ¢ëÁºñÂè∑" width="200" sortable>
              <template #default="scope">
                <el-tag>{{ scope.row.video_id }}</el-tag>
              </template>
            </el-table-column>
            
            <el-table-column label="Â≠óÂπïÁä∂ÊÄÅ" width="120" align="center">
              <template #default="scope">
                <el-tag :type="scope.row.filename ? 'success' : 'danger'">
                  {{ scope.row.filename ? '‚úÖÂ∑≤‰∏ä‰º†' : '‚ùåÁº∫Â§±' }}
                </el-tag>
              </template>
            </el-table-column>

            <!-- ‰ªòË¥πÊ†áËØÜÂàó -->
            <el-table-column label="‰ªòË¥πÁä∂ÊÄÅ" width="100" align="center">
              <template #default="scope">
                <el-tag v-if="scope.row.filename" :type="scope.row.is_paid ? 'warning' : 'info'" size="small">
                  {{ scope.row.is_paid ? 'üí∞‰ªòË¥π' : 'üÜìÂÖçË¥π' }}
                </el-tag>
                <span v-else style="color: #ccc;">-</span>
              </template>
            </el-table-column>
            
            <el-table-column prop="filename" label="Êñá‰ª∂Âêç" min-width="200">
              <template #default="scope">
                <span v-if="scope.row.filename">{{ scope.row.original_filename || scope.row.filename }}</span>
                <span v-else style="color: #ccc;">-</span>
              </template>
            </el-table-column>
            
            <!-- Êñ∞Â¢ûÔºöHASH ÂàóÔºàÊòæÁ§∫ÂâçÁºÄÔºåÊÇ¨ÊµÆÂèØËßÅÂÆåÊï¥ÂÄºÔºåÊîØÊåÅÂ§çÂà∂Ôºâ -->
            <el-table-column prop="content_hash" label="HASH" width="220">
              <template #default="scope">
                <template v-if="scope.row.filename && scope.row.content_hash">
                  <el-tooltip effect="dark" :content="scope.row.content_hash" placement="top">
                    <span class="monospace">{{ scope.row.content_hash.slice(0, 16) }}...</span>
                  </el-tooltip>
                  <el-link type="primary" :underline="false" style="margin-left:8px;" @click="copyText(scope.row.content_hash)">Â§çÂà∂</el-link>
                </template>
                <span v-else style="color:#ccc;">-</span>
              </template>
            </el-table-column>
            
            <el-table-column prop="file_size" label="Êñá‰ª∂Â§ßÂ∞è" width="120" align="right">
              <template #default="scope">
                <span v-if="scope.row.file_size">{{ formatFileSize(scope.row.file_size) }}</span>
                <span v-else style="color: #ccc;">-</span>
              </template>
            </el-table-column>
            
            <!-- Êñ∞Â¢ûÔºöÁÇπËµûÊï∞Âàó -->
            <el-table-column prop="likes_count" label="ÁÇπËµûÊï∞" width="120" align="right" sortable>
              <template #default="scope">
                <span>{{ scope.row.likes_count ?? 0 }}</span>
              </template>
            </el-table-column>
            
            <el-table-column prop="updated_at" label="Êõ¥Êñ∞Êó∂Èó¥" width="180">
              <template #default="scope">
                <span v-if="scope.row.updated_at">{{ formatDate(scope.row.updated_at) }}</span>
                <span v-else style="color: #ccc;">-</span>
              </template>
            </el-table-column>
            
            <el-table-column label="Êìç‰Ωú" width="200" align="center" fixed="right">
              <template #default="scope">
                <div class="action-buttons">
                  <el-button
                    v-if="scope.row.filename"
                    size="small"
                    @click="previewSubtitle(scope.row)"
                    title="È¢ÑËßà"
                  >
                    <el-icon><View /></el-icon>
                  </el-button>
                  
                  <el-button
                    v-if="scope.row.filename"
                    size="small"
                    type="warning"
                    @click="updateSubtitle(scope.row)"
                    title="Êõ¥Êñ∞"
                  >
                    <el-icon><Edit /></el-icon>
                  </el-button>

                  <el-button
                    v-if="scope.row.filename"
                    size="small"
                    :type="scope.row.is_paid ? 'info' : 'warning'"
                    @click="togglePaidStatus(scope.row)"
                    :title="scope.row.is_paid ? 'ËÆæ‰∏∫ÂÖçË¥π' : 'ËÆæ‰∏∫‰ªòË¥π'"
                  >
                    <el-icon v-if="scope.row.is_paid">üîì</el-icon>
                    <el-icon v-else>üîí</el-icon>
                  </el-button>
                  
                  <el-button
                    v-if="!scope.row.filename"
                    size="small"
                    type="primary"
                    @click="uploadSubtitle(scope.row.video_id)"
                    title="‰∏ä‰º†"
                  >
                    <el-icon><Upload /></el-icon>
                  </el-button>
                  
                  <el-button
                    v-if="scope.row.filename"
                    size="small"
                    type="danger"
                    @click="deleteSubtitle(scope.row)"
                    title="Âà†Èô§"
                  >
                    <el-icon><Delete /></el-icon>
                  </el-button>
                </div>
              </template>
            </el-table-column>
          </el-table>

          <!-- ÂàÜÈ°µ -->
          <div class="pagination-wrapper">
            <el-pagination
              :current-page="pagination.page"
              :page-size="pagination.limit"
              :page-sizes="[20, 50, 100]"
              :total="pagination.total"
              layout="total, sizes, prev, pager, next, jumper"
              @size-change="handleSizeChange"
              @current-change="handleCurrentChange"
            />
          </div>
        </el-card>

        <!-- ‰∏ä‰º†ÂØπËØùÊ°Ü -->
        <UploadDialog
          v-model="showUploadDialog"
          :video-id="selectedVideoId"
          @success="handleUploadSuccess"
        />

        <!-- ÊâπÈáè‰∏ä‰º†ÂØπËØùÊ°Ü -->
        <BatchUploadDialog
          v-model="showBatchUploadDialog"
          @success="handleUploadSuccess"
        />

        <!-- È¢ÑËßàÂØπËØùÊ°Ü -->
        <PreviewDialog
          v-model="showPreviewDialog"
          :subtitle-data="previewData"
        />

        <!-- ÂøÉÊÑøÂçïÊâπÈáè‰∏ä‰º†ÂØπËØùÊ°Ü Â∑≤ÁßªËá≥ÂøÉÊÑøÂçïÊ†áÁ≠æÈ°µÂÜÖ -->
      </el-tab-pane>

      <el-tab-pane label="Áî®Êà∑ÁÆ°ÁêÜ" name="users">
        <UserManagement />
      </el-tab-pane>

      <el-tab-pane label="‰ΩøÁî®ÁõëÊéß" name="usage-monitoring">
        <UsageMonitoringPlus />
      </el-tab-pane>

      <!-- Êñ∞Â¢ûÔºöÂøÉÊÑøÂçïÁÆ°ÁêÜ -->
      <el-tab-pane label="ÂøÉÊÑøÂçï" name="wishlist">
        <div class="toolbar">
          <div class="toolbar-left">
            <el-button @click="refreshWishlist" :loading="wishlist.loading">
              <el-icon><Refresh /></el-icon>
              Âà∑Êñ∞
            </el-button>
            <el-button type="primary" @click="showWishlistBatchUploadDialog = true" style="margin-left: 8px;">
              <el-icon><Upload /></el-icon>
              ÊâπÈáè‰∏ä‰º†Â≠óÂπï
            </el-button>
            <el-button @click="exportUnupdated" :loading="wishlist.exporting" style="margin-left: 8px;">
              <el-icon><Download /></el-icon>
              ÂØºÂá∫Êú™Êõ¥Êñ∞ÂøÉÊÑøÂçï
            </el-button>
          </div>
          <div class="toolbar-right">
            <el-input
              v-model="wishlist.searchQuery"
              placeholder="ÊêúÁ¥¢Áî®Êà∑ÂêçÊàñÈÇÆÁÆ±..."
              prefix-icon="Search"
              style="width: 300px; margin-right: 16px"
              @input="handleWishlistSearch"
              @keyup.enter="handleWishlistSearch"
              clearable
            />
            <span style="color:#666">ÂÖ± {{ wishlist.items.length }} Êù°</span>
          </div>
        </div>
        <el-card class="table-card">
          <el-table :data="wishlist.items" v-loading="wishlist.loading" height="400" stripe style="width:100%">
            <el-table-column prop="id" label="ID" width="80" align="right" />
            <el-table-column label="Áî®Êà∑" min-width="200">
              <template #default="scope">
                <div>
                  <div>{{ scope.row.username || ('Áî®Êà∑#' + scope.row.user_id) }}</div>
                  <div style="color:#999;font-size:12px">{{ scope.row.email || '-' }}</div>
                </div>
              </template>
            </el-table-column>
            <el-table-column prop="video_id" label="ËßÜÈ¢ëÁºñÂè∑" width="200">
              <template #default="scope">
                <el-tag>{{ scope.row.video_id }}</el-tag>
              </template>
            </el-table-column>
            <el-table-column prop="base_video_id" label="Âü∫Á°ÄID" width="160" />
            <el-table-column label="Â§áÊ≥®" min-width="200">
              <template #default="scope">
                <div v-if="!scope.row.note || !scope.row.note.trim()" style="color: #ccc;">-</div>
                <el-popover
                  v-else
                  trigger="click"
                  placement="right"
                  :width="480"
                  popper-class="note-popover"
                >
                  <template #reference>
                    <div class="note-clamp-2" role="button" tabindex="0">
                      {{ scope.row.note }}
                      <el-link v-if="isLongText(scope.row.note)" type="primary" size="small" style="margin-left: 8px;">Êü•ÁúãÂÖ®ÈÉ®</el-link>
                    </div>
                  </template>
                  <div class="note-full-content">{{ scope.row.note }}</div>
                  <div class="popover-actions">
                    <el-button size="small" plain @click="copyText(scope.row.note)">Â§çÂà∂Â§áÊ≥®</el-button>
                  </div>
                </el-popover>
              </template>
            </el-table-column>
            <el-table-column prop="status" label="Áä∂ÊÄÅ" width="120" align="center">
              <template #default="scope">
                <el-tag :type="scope.row.status === 'Â∑≤Êõ¥Êñ∞' ? 'success' : 'warning'">
                  {{ scope.row.status }}
                </el-tag>
              </template>
            </el-table-column>
            <el-table-column prop="created_at" label="ÂàõÂª∫Êó∂Èó¥" width="180">
              <template #default="scope">
                {{ formatDate(scope.row.created_at) }}
              </template>
            </el-table-column>
            <el-table-column prop="updated_at" label="Êõ¥Êñ∞Êó∂Èó¥" width="180">
              <template #default="scope">
                {{ formatDate(scope.row.updated_at) }}
              </template>
            </el-table-column>
            <el-table-column label="Êìç‰Ωú" width="160" align="center" fixed="right">
               <template #default="scope">
                 <el-button
                   size="small"
                   :type="scope.row.status === 'Â∑≤Êõ¥Êñ∞' ? 'success' : 'primary'"
                   :loading="wishlist.updatingId === scope.row.id"
                   @click="toggleWishlistStatus(scope.row)"
                 >
                   {{ scope.row.status === 'Â∑≤Êõ¥Êñ∞' ? 'Ê†áËÆ∞Êú™Êõ¥Êñ∞' : 'Ê†áËÆ∞Â∑≤Êõ¥Êñ∞' }}
                 </el-button>
               </template>
             </el-table-column>
          </el-table>
          <div class="pagination-wrapper" style="margin-top:16px; text-align: center;">
            <el-pagination
              :current-page="wishlist.page"
              :page-size="wishlist.limit"
              :page-sizes="[10, 20, 50, 100]"
              :total="wishlist.total"
              layout="total, sizes, prev, pager, next, jumper"
              @size-change="handleWishlistSizeChange"
              @current-change="handleWishlistCurrentChange"
            />
          </div>
        </el-card>

        <!-- ÂøÉÊÑøÂçïÊâπÈáè‰∏ä‰º†ÂØπËØùÊ°Ü ÊîæÁΩÆÂú®ÂøÉÊÑøÂçïÊ†áÁ≠æÈ°µÂÜÖÁ°Æ‰øùÂèØËßÅ -->
        <WishlistBatchUploadDialog
          v-model="showWishlistBatchUploadDialog"
          @success="handleWishlistBatchUploadSuccess"
        />
      </el-tab-pane>

      <!-- ÈÄöÁü•ÁÆ°ÁêÜ -->
      <el-tab-pane label="ÈÄöÁü•ÁÆ°ÁêÜ" name="notifications">
        <div class="toolbar">
          <div class="toolbar-left">
            <el-button type="primary" @click="showBroadcastDialog = true">
              <el-icon><Bell /></el-icon>
              ÂèëÈÄÅÁ≥ªÁªüÈÄöÁü•
            </el-button>
            <el-button @click="refreshNotifications" :loading="notifications.loading">
              <el-icon><Refresh /></el-icon>
              Âà∑Êñ∞
            </el-button>
          </div>
          <div class="toolbar-right">
            <el-input
              v-model="notifications.searchQuery"
              placeholder="ÊêúÁ¥¢ÈÄöÁü•ÂÜÖÂÆπ..."
              prefix-icon="Search"
              style="width: 300px; margin-right: 16px"
              @input="handleNotificationSearch"
              clearable
            />
            <span style="color:#666">ÂÖ± {{ notifications.total }} Êù°</span>
          </div>
        </div>

        <!-- ÈÄöÁü•ÁªüËÆ°Âç°Áâá -->
        <div class="stats-cards">
          <el-card class="stat-card">
            <div class="stat-content">
              <div class="stat-number">{{ notificationStats.total }}</div>
              <div class="stat-label">ÊÄªÈÄöÁü•Êï∞</div>
            </div>
            <div class="stat-icon">
              <el-icon><Bell /></el-icon>
            </div>
          </el-card>
          <el-card class="stat-card">
            <div class="stat-content">
              <div class="stat-number">{{ notificationStats.system }}</div>
              <div class="stat-label">Á≥ªÁªüÈÄöÁü•</div>
            </div>
            <div class="stat-icon">
              <el-icon><Message /></el-icon>
            </div>
          </el-card>
          <el-card class="stat-card">
            <div class="stat-content">
              <div class="stat-number">{{ notificationStats.mention }}</div>
              <div class="stat-label">@ÊèêÂèäÈÄöÁü•</div>
            </div>
            <div class="stat-icon">
              <el-icon><ChatDotRound /></el-icon>
            </div>
          </el-card>
          <el-card class="stat-card">
            <div class="stat-content">
              <div class="stat-number">{{ notificationStats.today }}</div>
              <div class="stat-label">‰ªäÊó•ÂèëÈÄÅ</div>
            </div>
            <div class="stat-icon">
              <el-icon><Calendar /></el-icon>
            </div>
          </el-card>
        </div>

        <!-- ÈÄöÁü•ÂàóË°® -->
        <el-card class="table-card">
          <el-table :data="notifications.items" v-loading="notifications.loading" height="400" stripe style="width:100%">
            <el-table-column prop="id" label="ID" width="80" align="right" />
            <el-table-column label="Á±ªÂûã" width="120" align="center">
              <template #default="scope">
                <el-tag :type="scope.row.type === 'system' ? 'primary' : 'success'">
                  {{ scope.row.type === 'system' ? 'Á≥ªÁªüÈÄöÁü•' : '@ÊèêÂèä' }}
                </el-tag>
              </template>
            </el-table-column>
            <el-table-column prop="title" label="Ê†áÈ¢ò" min-width="200" />
            <el-table-column label="ÂÜÖÂÆπ" min-width="300">
              <template #default="scope">
                <div v-if="!scope.row.content || !scope.row.content.trim()" style="color: #ccc;">-</div>
                <el-popover
                  v-else
                  trigger="click"
                  placement="right"
                  :width="480"
                  popper-class="note-popover"
                >
                  <template #reference>
                    <div class="note-clamp-2" role="button" tabindex="0">
                      {{ scope.row.content }}
                      <el-link v-if="isLongText(scope.row.content)" type="primary" size="small" style="margin-left: 8px;">Êü•ÁúãÂÖ®ÈÉ®</el-link>
                    </div>
                  </template>
                  <div class="note-full-content">{{ scope.row.content }}</div>
                  <div class="popover-actions">
                    <el-button size="small" plain @click="copyText(scope.row.content)">Â§çÂà∂ÂÜÖÂÆπ</el-button>
                  </div>
                </el-popover>
              </template>
            </el-table-column>
            <el-table-column label="Êé•Êî∂Áî®Êà∑" width="120" align="center">
              <template #default="scope">
                <span v-if="scope.row.receiver_username">{{ scope.row.receiver_username }}</span>
                <el-tag v-else-if="!scope.row.user_id" type="warning">ÂÖ®‰ΩìÁî®Êà∑</el-tag>
                <span v-else>Áî®Êà∑#{{ scope.row.user_id }}</span>
              </template>
            </el-table-column>
            <el-table-column label="Âà†Èô§Áä∂ÊÄÅ" width="120" align="center">
              <template #default="scope">
                <span v-if="!scope.row.user_id" style="color: #999;">-</span>
                <el-tag v-else-if="scope.row.is_deleted === 1" type="danger" size="small">
                  Â∑≤Âà†Èô§
                </el-tag>
                <el-tag v-else type="success" size="small">
                  Êú™Âà†Èô§
                </el-tag>
                <div v-if="scope.row.is_deleted === 1 && scope.row.deleted_at" 
                     style="color: #999; font-size: 11px; margin-top: 2px;">
                  {{ formatDate(scope.row.deleted_at) }}
                </div>
              </template>
            </el-table-column>
            <el-table-column prop="created_at" label="ÂèëÈÄÅÊó∂Èó¥" width="180">
              <template #default="scope">
                {{ formatDate(scope.row.created_at) }}
              </template>
            </el-table-column>
            <el-table-column label="Êìç‰Ωú" width="120" align="center" fixed="right">
              <template #default="scope">
                <el-button
                  size="small"
                  type="danger"
                  :loading="notifications.deletingId === scope.row.id"
                  @click="deleteNotification(scope.row)"
                >
                  Âà†Èô§
                </el-button>
              </template>
            </el-table-column>
          </el-table>
          <div class="pagination-wrapper" style="margin-top:16px; text-align: center;">
            <el-pagination
              :current-page="notifications.page"
              :page-size="notifications.limit"
              :page-sizes="[10, 20, 50, 100]"
              :total="notifications.total"
              layout="total, sizes, prev, pager, next, jumper"
              @size-change="handleNotificationSizeChange"
              @current-change="handleNotificationCurrentChange"
            />
          </div>
        </el-card>

        <!-- ÂèëÈÄÅÁ≥ªÁªüÈÄöÁü•ÂØπËØùÊ°Ü -->
        <el-dialog
          v-model="showBroadcastDialog"
          title="ÂèëÈÄÅÁ≥ªÁªüÈÄöÁü•"
          width="600px"
          :close-on-click-modal="false"
        >
          <el-form :model="broadcastForm" :rules="broadcastRules" ref="broadcastFormRef" label-width="80px">
            <el-form-item label="ÈÄöÁü•Ê†áÈ¢ò" prop="title">
              <el-input
                v-model="broadcastForm.title"
                placeholder="ËØ∑ËæìÂÖ•ÈÄöÁü•Ê†áÈ¢ò"
                maxlength="100"
                show-word-limit
              />
            </el-form-item>
            <el-form-item label="ÈÄöÁü•ÂÜÖÂÆπ" prop="content">
              <el-input
                v-model="broadcastForm.content"
                type="textarea"
                :rows="4"
                placeholder="ËØ∑ËæìÂÖ•ÈÄöÁü•ÂÜÖÂÆπ"
                maxlength="500"
                show-word-limit
              />
            </el-form-item>
            <el-form-item label="Ë∑≥ËΩ¨ÈìæÊé•">
              <el-input
                v-model="broadcastForm.link"
                placeholder="ÂèØÈÄâÔºåÁÇπÂáªÈÄöÁü•ÂêéË∑≥ËΩ¨ÁöÑÈìæÊé•"
              />
            </el-form-item>
          </el-form>
          <template #footer>
            <span class="dialog-footer">
              <el-button @click="showBroadcastDialog = false">ÂèñÊ∂à</el-button>
              <el-button type="primary" @click="sendBroadcast" :loading="broadcasting">
                ÂèëÈÄÅÈÄöÁü•
              </el-button>
            </span>
          </template>
        </el-dialog>
      </el-tab-pane>
    </el-tabs>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted, computed, watch } from 'vue'
import { useRouter } from 'vue-router'
import { ElMessage, ElMessageBox } from 'element-plus'
import { subtitleAPI, wishlistAPI, notificationAPI } from '../utils/api'
import UploadDialog from '../components/UploadDialog.vue'
import BatchUploadDialog from '../components/BatchUploadDialog.vue'
import PreviewDialog from '../components/PreviewDialog.vue'
import WishlistBatchUploadDialog from '../components/WishlistBatchUploadDialog.vue'
import UserManagement from './UserManagement.vue'
import UsageMonitoringPlus from './UsageMonitoringPlus.vue'

const router = useRouter()

// Êñ∞Â¢ûÔºöÊ†áÁ≠æÁä∂ÊÄÅ
defineOptions({ name: 'Dashboard' })
const activeTab = ref('subtitles')

// ‰øÆÂ§çÔºöElement Plus ‰ΩøÁî® tab-click ‰∫ã‰ª∂Ôºå‰∏îÂ¢ûÂä† watch ÂÖúÂ∫ï
const onTabClick = async (pane) => {
  const name = pane?.paneName ?? pane?.name ?? ''
  if (name === 'wishlist' && wishlist.items.length === 0) {
    await loadWishlistPage()
  } else if (name === 'notifications' && notifications.items.length === 0) {
    await loadNotifications()
    await loadNotificationStats()
  }
}

watch(activeTab, async (name) => {
  if (name === 'wishlist' && wishlist.items.length === 0) {
    await loadWishlistPage()
  } else if (name === 'notifications' && notifications.items.length === 0) {
    await loadNotifications()
    await loadNotificationStats()
  }
})
// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const loading = ref(false)
const exporting = ref(false)
const deleting = ref(false)
const deletingAll = ref(false)
const searchQuery = ref('')
const tableData = ref([])
const tableRef = ref()
const selectedIds = ref(new Set())
const showUploadDialog = ref(false)
const showBatchUploadDialog = ref(false)
const showWishlistBatchUploadDialog = ref(false)
const showPreviewDialog = ref(false)
const selectedVideoId = ref('')
const previewData = ref(null)

const pagination = reactive({
  page: 1,
  limit: 50,
  total: 0
})

// Êñ∞Â¢ûÔºöÂøÉÊÑøÂçïÊï∞ÊçÆÔºàÈ°µÁ†ÅÂàÜÈ°µÔºâ
const wishlist = reactive({
  items: [],
  nextCursor: null,
  limit: 50,
  loading: false,
  hasMore: true,
  updatingId: 0,
  searchQuery: '',
  // È°µÁ†ÅÂàÜÈ°µÂ≠óÊÆµ
  page: 1,
  total: 0,
  exporting: false
})

// ÈÄöÁü•ÁÆ°ÁêÜÊï∞ÊçÆ
const notifications = reactive({
  items: [],
  loading: false,
  searchQuery: '',
  page: 1,
  limit: 20,
  total: 0,
  deletingId: 0
})

// ÈÄöÁü•ÁªüËÆ°Êï∞ÊçÆ
const notificationStats = reactive({
  total: 0,
  system: 0,
  mention: 0,
  today: 0
})

// Á≥ªÁªüÂπøÊí≠Áõ∏ÂÖ≥
const showBroadcastDialog = ref(false)
const broadcasting = ref(false)
const broadcastFormRef = ref()
const broadcastForm = reactive({
  title: '',
  content: '',
  link: ''
})

const broadcastRules = {
  title: [
    { required: true, message: 'ËØ∑ËæìÂÖ•ÈÄöÁü•Ê†áÈ¢ò', trigger: 'blur' },
    { min: 1, max: 100, message: 'Ê†áÈ¢òÈïøÂ∫¶Âú® 1 Âà∞ 100 ‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ],
  content: [
    { required: true, message: 'ËØ∑ËæìÂÖ•ÈÄöÁü•ÂÜÖÂÆπ', trigger: 'blur' },
    { min: 1, max: 500, message: 'ÂÜÖÂÆπÈïøÂ∫¶Âú® 1 Âà∞ 500 ‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ]
}

// ÂΩìÂâçÁî®Êà∑
const currentUser = computed(() => {
  const user = localStorage.getItem('admin_user')
  return user ? JSON.parse(user) : { username: 'Admin' }
})

// È°∂ÈÉ®ÁªüËÆ°ÔºàÂÖ®ÈáèÔºâ
const allStats = reactive({ total: 0, hasSubtitle: 0, missing: 0, completion: 0 })

const fetchStats = async () => {
  try {
    const res = await subtitleAPI.getStats({ search: searchQuery.value })
    allStats.total = res.total
    allStats.hasSubtitle = res.hasSubtitle
    allStats.missing = res.missing
    allStats.completion = res.completion
  } catch (e) {
    // ÂøΩÁï•ÁªüËÆ°Â§±Ë¥•
  }
}

// ÊñπÊ≥ï
const loadData = async () => {
  loading.value = true
  try {
    const params = {
      page: pagination.page,
      limit: pagination.limit,
      search: searchQuery.value
    }
    
    const response = await subtitleAPI.getList(params)
    tableData.value = response.data
    pagination.total = response.pagination.total
    await fetchStats()
  } catch (error) {
    console.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', error)
  } finally {
    loading.value = false
  }
}

// Êñ∞Â¢ûÔºöÂøÉÊÑøÂçïÂØºÂá∫ÊñπÊ≥ïÔºàÊúÄÂ∞è‰æµÂÖ•Ôºâ
const exportUnupdated = async () => {
  if (wishlist.exporting) return
  const token = localStorage.getItem('admin_token')
  if (!token) {
    ElMessage.error('ËØ∑ÂÖàÁôªÂΩï')
    return
  }
  wishlist.exporting = true
  try {
    const { blob, filename } = await wishlistAPI.exportUnupdated()
    const url = window.URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = filename || 'wishlist-unupdated.json'
    document.body.appendChild(a)
    a.click()
    a.remove()
    window.URL.revokeObjectURL(url)
    ElMessage.success('ÂØºÂá∫ÊàêÂäü')
  } catch (e) {
    console.error(e)
    ElMessage.error(e.message || 'ÂØºÂá∫Â§±Ë¥•')
  } finally {
    wishlist.exporting = false
  }
}

// Êñ∞Â¢ûÔºöÂä†ËΩΩÂøÉÊÑøÂçïÔºàÈ°µÁ†ÅÂàÜÈ°µÔºâ
const loadWishlistPage = async () => {
  if (wishlist.loading) return
  wishlist.loading = true
  try {
    const params = { 
      page: wishlist.page, 
      limit: wishlist.limit 
    }
    if (wishlist.searchQuery.trim()) params.search = wishlist.searchQuery.trim()
    const res = await wishlistAPI.getList(params)
    wishlist.items = res.data || []
    wishlist.total = res.pagination?.total || 0
  } catch (e) {
    console.error('Âä†ËΩΩÂøÉÊÑøÂçïÂ§±Ë¥•:', e)
  } finally {
    wishlist.loading = false
  }
}

const refreshWishlist = () => {
  wishlist.page = 1
  loadWishlistPage()
}

const handleWishlistSearch = () => {
  wishlist.page = 1
  loadWishlistPage()
}

const handleWishlistSizeChange = (limit) => {
  wishlist.limit = limit
  wishlist.page = 1
  loadWishlistPage()
}

const handleWishlistCurrentChange = (page) => {
  wishlist.page = page
  loadWishlistPage()
}

const handleSearch = () => {
  pagination.page = 1
  clearSelection()
  loadData()
}

const handleSizeChange = (size) => {
  pagination.limit = size
  pagination.page = 1
  clearSelection()
  loadData()
}

const handleCurrentChange = (page) => {
  pagination.page = page
  clearSelection()
  loadData()
}

const openCreateUploadDialog = () => {
  selectedVideoId.value = ''
  showUploadDialog.value = true
}

const uploadSubtitle = (videoId) => {
  selectedVideoId.value = ''
  showUploadDialog.value = true
}

const updateSubtitle = (row) => {
  selectedVideoId.value = row.video_id
  showUploadDialog.value = true
}

const previewSubtitle = async (row) => {
  try {
    const response = await subtitleAPI.getSubtitle(row.video_id)
    previewData.value = {
      video_id: row.video_id,
      filename: row.filename,
      content: response
    }
    showPreviewDialog.value = true
  } catch (error) {
    ElMessage.error('È¢ÑËßàÂ§±Ë¥•')
  }
}

const deleteSubtitle = async (row) => {
  try {
    await ElMessageBox.confirm(
      `Á°ÆÂÆöË¶ÅÂà†Èô§ËßÜÈ¢ë "${row.video_id}" ÁöÑÂ≠óÂπïÊñá‰ª∂ÂêóÔºü`,
      'Á°ÆËÆ§Âà†Èô§',
      {
        confirmButtonText: 'Á°ÆÂÆö',
        cancelButtonText: 'ÂèñÊ∂à',
        type: 'warning'
      }
    )
    
    await subtitleAPI.delete(row.video_id)
    ElMessage.success('Âà†Èô§ÊàêÂäü')
    await loadData()
  } catch (error) {
    if (error !== 'cancel') {
      console.error('Âà†Èô§Â§±Ë¥•:', error)
    }
  }
}

// ÂàáÊç¢‰ªòË¥πÁä∂ÊÄÅ
const togglePaidStatus = async (row) => {
  const newStatus = row.is_paid ? 0 : 1
  const statusText = newStatus ? '‰ªòË¥π' : 'ÂÖçË¥π'
  
  try {
    await ElMessageBox.confirm(
      `Á°ÆÂÆöË¶ÅÂ∞ÜËßÜÈ¢ë "${row.video_id}" ÁöÑÂ≠óÂπïËÆæÁΩÆ‰∏∫${statusText}ÂêóÔºü`,
      'Á°ÆËÆ§‰øÆÊîπ',
      {
        confirmButtonText: 'Á°ÆÂÆö',
        cancelButtonText: 'ÂèñÊ∂à',
        type: 'warning'
      }
    )
    
    // Ë∞ÉÁî®Êõ¥Êñ∞Êé•Âè£Ôºå‰º†ÈÄíis_paidÂèÇÊï∞
    const formData = new FormData()
    formData.append('is_paid', newStatus)
    
    await subtitleAPI.update(row.video_id, formData)
    ElMessage.success(`Â∑≤ËÆæÁΩÆ‰∏∫${statusText}Â≠óÂπï`)
    await loadData()
  } catch (error) {
    if (error !== 'cancel') {
      console.error('‰øÆÊîπ‰ªòË¥πÁä∂ÊÄÅÂ§±Ë¥•:', error)
      ElMessage.error('‰øÆÊîπÂ§±Ë¥•')
    }
  }
}

// Êñ∞Â¢ûÔºöÂàáÊç¢ÂøÉÊÑøÂçïÁä∂ÊÄÅ
const toggleWishlistStatus = async (row) => {
  const newStatus = row.status === 'Â∑≤Êõ¥Êñ∞' ? 'Êú™Êõ¥Êñ∞' : 'Â∑≤Êõ¥Êñ∞'
  wishlist.updatingId = row.id
  try {
    const res = await wishlistAPI.updateStatus(row.id, newStatus)
    const updated = res.item || {}
    row.status = updated.status || newStatus
    row.updated_at = updated.updated_at || row.updated_at
    ElMessage.success('Êõ¥Êñ∞ÊàêÂäü')
  } catch (e) {
    console.error(e)
    ElMessage.error('Êõ¥Êñ∞Â§±Ë¥•')
  } finally {
    wishlist.updatingId = 0
  }
}

// Â§áÊ≥®Áõ∏ÂÖ≥ÊñπÊ≥ï
const isLongText = (text) => {
  return !!text && text.trim().length > 50
}

const copyText = async (text) => {
  try {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      await navigator.clipboard.writeText(text)
      ElMessage.success('Â§çÂà∂ÊàêÂäü')
    } else {
      // ÂõûÈÄÄÊñπÊ°à
      const textarea = document.createElement('textarea')
      textarea.value = text
      document.body.appendChild(textarea)
      textarea.select()
      document.execCommand('copy')
      document.body.removeChild(textarea)
      ElMessage.success('Â§çÂà∂ÊàêÂäü')
    }
  } catch (error) {
    console.error('Â§çÂà∂Â§±Ë¥•:', error)
    ElMessage.error('Â§çÂà∂Â§±Ë¥•')
  }
}

// ÈÄâÊã©Áõ∏ÂÖ≥
const onSelectionChange = (rows) => {
  const ids = new Set(rows.map(r => r.video_id))
  selectedIds.value = ids
}

const clearSelection = () => {
  selectedIds.value = new Set()
  if (tableRef.value) tableRef.value.clearSelection()
}

const selectAllCurrentPage = () => {
  if (!tableRef.value) return
  tableRef.value.clearSelection()
  tableData.value.forEach(row => tableRef.value.toggleRowSelection(row, true))
}

const invertSelection = () => {
  if (!tableRef.value) return
  const currentSelected = new Set([...selectedIds.value])
  tableRef.value.clearSelection()
  tableData.value.forEach(row => {
    const willSelect = !currentSelected.has(row.video_id)
    if (willSelect) tableRef.value.toggleRowSelection(row, true)
  })
}

const bulkDelete = async () => {
  if (!selectedIds.value.size) return
  try {
    await ElMessageBox.confirm(
      `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedIds.value.size} Êù°Â≠óÂπïËÆ∞ÂΩïÂêóÔºü`,
      'ÊâπÈáèÂà†Èô§',
      {
        confirmButtonText: 'Á°ÆÂÆö',
        cancelButtonText: 'ÂèñÊ∂à',
        type: 'warning'
      }
    )

    deleting.value = true
    const ids = [...selectedIds.value]
    const res = await subtitleAPI.bulkDelete(ids)
    const successCount = res.deleted || 0
    const failedCount = res.failed ? Object.keys(res.failed).length : 0

    if (failedCount === 0) {
      ElMessage.success(`Â∑≤Âà†Èô§ ${successCount} Êù°`)
    } else {
      ElMessage.warning(`ÊàêÂäü ${successCount} Êù°ÔºåÂ§±Ë¥• ${failedCount} Êù°`)
    }

    clearSelection()
    await loadData()
  } catch (e) {
    if (e !== 'cancel') {
      console.error(e)
    }
  } finally {
    deleting.value = false
  }
}

const deleteAllSubtitles = async () => {
  try {
    await ElMessageBox.confirm(
      'Ê≠§Êìç‰ΩúÂ∞ÜÂà†Èô§ÊâÄÊúâÂ≠óÂπïÊñá‰ª∂ÂíåÊï∞ÊçÆÂ∫ìËÆ∞ÂΩïÔºå‰∏îÊó†Ê≥ïÊÅ¢Â§çÔºÅ',
      'Âç±Èô©Êìç‰ΩúÔºöÂÖ®ÈÉ®Âà†Èô§',
      {
        confirmButtonText: 'ÊàëÁ°ÆËÆ§Âà†Èô§ÂÖ®ÈÉ®',
        cancelButtonText: 'ÂèñÊ∂à',
        type: 'error',
        dangerouslyUseHTMLString: true,
        message: `
          <div style="color: #f56c6c; font-weight: bold; margin-bottom: 10px;">
            ‚ö†Ô∏è Ë≠¶ÂëäÔºöÊ≠§Êìç‰Ωú‰∏çÂèØÈÄÜÔºÅ
          </div>
          <div>
            ‚Ä¢ Â∞ÜÂà†Èô§ÊâÄÊúâÂ≠óÂπïÊñá‰ª∂<br>
            ‚Ä¢ Â∞ÜÊ∏ÖÁ©∫Â≠óÂπïÊï∞ÊçÆÂ∫ìËÆ∞ÂΩï<br>
            ‚Ä¢ Êìç‰ΩúÂÆåÊàêÂêéÊó†Ê≥ïÊÅ¢Â§ç
          </div>
        `
      }
    )

    // ‰∫åÊ¨°Á°ÆËÆ§
    await ElMessageBox.confirm(
      'ËØ∑ÂÜçÊ¨°Á°ÆËÆ§ÔºöÊÇ®ÁúüÁöÑË¶ÅÂà†Èô§ÊâÄÊúâÂ≠óÂπïÂêóÔºü',
      'ÊúÄÁªàÁ°ÆËÆ§',
      {
        confirmButtonText: 'Á°ÆËÆ§Âà†Èô§ÂÖ®ÈÉ®',
        cancelButtonText: 'ÂèñÊ∂à',
        type: 'error'
      }
    )

    deletingAll.value = true
    const res = await subtitleAPI.deleteAll()
    
    if (res.processing) {
      ElMessage.success(`Â∑≤ÂºÄÂßãÂà†Èô§ ${res.total} ‰∏™Â≠óÂπïÊñá‰ª∂ÔºåËØ∑Á®çÂÄô...`)
      
      // ËΩÆËØ¢Ê£ÄÊü•Âà†Èô§Áä∂ÊÄÅ
      const checkDeleteStatus = async () => {
        try {
          const status = await subtitleAPI.getDeleteStatus()
          if (status.completed) {
            await loadData()
            ElMessage.success('ÂÖ®ÈÉ®Âà†Èô§Êìç‰ΩúÂ∑≤ÂÆåÊàê')
            deletingAll.value = false
          } else {
            // ÁªßÁª≠ËΩÆËØ¢
            setTimeout(checkDeleteStatus, 2000) // ÊØè2ÁßíÊ£ÄÊü•‰∏ÄÊ¨°
          }
        } catch (error) {
          console.error('Ê£ÄÊü•Âà†Èô§Áä∂ÊÄÅÂ§±Ë¥•:', error)
          // Â¶ÇÊûúÊ£ÄÊü•Â§±Ë¥•ÔºåÂª∂ËøüÂà∑Êñ∞‰Ωú‰∏∫Â§áÈÄâÊñπÊ°à
          setTimeout(async () => {
            await loadData()
            ElMessage.success('ÂÖ®ÈÉ®Âà†Èô§Êìç‰ΩúÂ∑≤ÂÆåÊàê')
            deletingAll.value = false
          }, 5000)
        }
      }
      
      // ÂºÄÂßãËΩÆËØ¢
      setTimeout(checkDeleteStatus, 2000)
    } else {
      ElMessage.success(`Â∑≤Âà†Èô§ ${res.deleted} ‰∏™Â≠óÂπïÊñá‰ª∂`)
      await loadData()
      deletingAll.value = false
    }
    
    clearSelection()
  } catch (e) {
    if (e !== 'cancel') {
      console.error('Âà†Èô§Â§±Ë¥•:', e)
      ElMessage.error('Âà†Èô§Â§±Ë¥•ÔºåËØ∑ÈáçËØï')
    }
    deletingAll.value = false
  }
}

const handleUploadSuccess = () => { loadData() }

// ÂøÉÊÑøÂçïÊâπÈáè‰∏ä‰º†ÊàêÂäüÂ§ÑÁêÜ
const handleWishlistBatchUploadSuccess = () => {
  ElMessage.success('ÊâπÈáè‰∏ä‰º†ÂÆåÊàê')
  refreshWishlist()
}

// Êñ∞Â¢ûÔºöÈÄÄÂá∫ÁôªÂΩï
const handleLogout = async () => {
  try {
    await ElMessageBox.confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºü', 'Á°ÆËÆ§ÈÄÄÂá∫', {
      confirmButtonText: 'Á°ÆÂÆö',
      cancelButtonText: 'ÂèñÊ∂à',
      type: 'warning'
    })
    localStorage.removeItem('admin_token')
    localStorage.removeItem('admin_user')
    ElMessage.success('Â∑≤ÈÄÄÂá∫ÁôªÂΩï')
    router.push('/login')
  } catch (error) {
    // Áî®Êà∑ÂèñÊ∂à
  }
}

const exportData = () => {
  exporting.value = true
  setTimeout(() => {
    const headers = ['ËßÜÈ¢ëÁºñÂè∑', 'Â≠óÂπïÁä∂ÊÄÅ', 'Êñá‰ª∂Âêç', 'HASH', 'Êñá‰ª∂Â§ßÂ∞è', 'Êõ¥Êñ∞Êó∂Èó¥']
    const rows = tableData.value.map(row => [
      row.video_id,
      row.filename ? 'Â∑≤‰∏ä‰º†' : 'Áº∫Â§±',
      (row.original_filename || row.filename || ''),
      (row.content_hash || ''),
      row.file_size ? formatFileSize(row.file_size) : '',
      row.updated_at ? formatDate(row.updated_at) : ''
    ])
    const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n')
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })
    const link = document.createElement('a')
    link.href = URL.createObjectURL(blob)
    link.download = 'subtitles.csv'
    link.click()
    URL.revokeObjectURL(link.href)
    exporting.value = false
    ElMessage.success('ÂØºÂá∫ÊàêÂäü')
  }, 1000)
}

const formatFileSize = (bytes) => {
  if (bytes === 0) return '0 B'
  const k = 1024
  const sizes = ['B', 'KB', 'MB', 'GB']
  const i = Math.floor(Math.log(bytes) / Math.log(k))
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
}

const formatDate = (dateString) => new Date(dateString).toLocaleString('zh-CN')

// ÈÄöÁü•ÁÆ°ÁêÜÊñπÊ≥ï
const loadNotifications = async () => {
  if (notifications.loading) return
  notifications.loading = true
  try {
    const params = {
      page: notifications.page,
      limit: notifications.limit
    }
    if (notifications.searchQuery.trim()) {
      params.search = notifications.searchQuery.trim()
    }
    const res = await notificationAPI.getList(params)
    notifications.items = res.data || []
    notifications.total = res.pagination?.total || 0
  } catch (e) {
    console.error('Âä†ËΩΩÈÄöÁü•Â§±Ë¥•:', e)
    ElMessage.error('Âä†ËΩΩÈÄöÁü•Â§±Ë¥•')
  } finally {
    notifications.loading = false
  }
}

const loadNotificationStats = async () => {
  try {
    const res = await notificationAPI.getStats()
    Object.assign(notificationStats, res)
  } catch (e) {
    console.error('Âä†ËΩΩÈÄöÁü•ÁªüËÆ°Â§±Ë¥•:', e)
  }
}

const refreshNotifications = () => {
  notifications.page = 1
  loadNotifications()
  loadNotificationStats()
}

const handleNotificationSearch = () => {
  notifications.page = 1
  loadNotifications()
}

const handleNotificationSizeChange = (limit) => {
  notifications.limit = limit
  notifications.page = 1
  loadNotifications()
}

const handleNotificationCurrentChange = (page) => {
  notifications.page = page
  loadNotifications()
}

const sendBroadcast = async () => {
  if (!broadcastFormRef.value) return
  
  try {
    await broadcastFormRef.value.validate()
  } catch {
    return
  }
  
  broadcasting.value = true
  try {
    await notificationAPI.broadcast({
      title: broadcastForm.title,
      content: broadcastForm.content,
      linkUrl: broadcastForm.link || null
    })
    
    ElMessage.success('Á≥ªÁªüÈÄöÁü•ÂèëÈÄÅÊàêÂäü')
    showBroadcastDialog.value = false
    
    // ÈáçÁΩÆË°®Âçï
    Object.assign(broadcastForm, {
      title: '',
      content: '',
      link: ''
    })
    
    // Âà∑Êñ∞ÈÄöÁü•ÂàóË°®ÂíåÁªüËÆ°
    refreshNotifications()
  } catch (e) {
    console.error('ÂèëÈÄÅÈÄöÁü•Â§±Ë¥•:', e)
    ElMessage.error('ÂèëÈÄÅÈÄöÁü•Â§±Ë¥•')
  } finally {
    broadcasting.value = false
  }
}

const deleteNotification = async (notification) => {
  try {
    await ElMessageBox.confirm(
      `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄöÁü•"${notification.title}"ÂêóÔºü`,
      'Á°ÆËÆ§Âà†Èô§',
      {
        confirmButtonText: 'Á°ÆÂÆö',
        cancelButtonText: 'ÂèñÊ∂à',
        type: 'warning'
      }
    )
    
    notifications.deletingId = notification.id
    await notificationAPI.delete(notification.id)
    
    ElMessage.success('Âà†Èô§ÊàêÂäü')
    refreshNotifications()
  } catch (e) {
    if (e !== 'cancel') {
      console.error('Âà†Èô§ÈÄöÁü•Â§±Ë¥•:', e)
      ElMessage.error('Âà†Èô§Â§±Ë¥•')
    }
  } finally {
    notifications.deletingId = 0
  }
}

onMounted(() => { loadData(); loadWishlistPage() })
</script>

<style scoped>
/* ‰øùÁïôÂéüÊ†∑Âºè */
.dashboard-container { padding: 20px; background-color: #f5f5f5; min-height: 100vh; }
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 6px 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); min-height: 40px; }
.header-left { display: flex; align-items: center; gap: 8px; }
.main-title { font-size: 18px; font-weight: bold; color: #303133; }
.separator { color: #dcdfe6; margin: 0 4px; }
.sub-title { font-size: 14px; color: #606266; }
.header-right { display: flex; align-items: center; gap: 12px; }
.welcome-text { font-size: 14px; color: #606266; }
.toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
.toolbar-left { display: flex; gap: 10px; }
.stats-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
.stat-card { cursor: default; }
.stat-card :deep(.el-card__body) { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
.stat-number { font-size: 32px; font-weight: bold; color: #409EFF; margin-bottom: 5px; }
.stat-label { color: #666; font-size: 14px; }
.stat-icon { font-size: 40px; color: #409EFF; opacity: 0.3; }
.table-card { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
.action-buttons { display: flex; gap: 5px; justify-content: center; }
.pagination-wrapper { display: flex; justify-content: center; margin-top: 20px; }

/* Â§áÊ≥®Áõ∏ÂÖ≥Ê†∑Âºè */
.note-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  white-space: pre-wrap;
  word-break: break-word;
  line-height: 1.5;
  cursor: pointer;
  transition: color 0.2s;
}

.note-clamp-2:hover {
  color: #409EFF;
}

/* Popover Ê†∑Âºè */
:deep(.note-popover) {
  max-width: 640px;
}

:deep(.note-popover .note-full-content) {
  white-space: pre-wrap;
  word-break: break-word;
  line-height: 1.6;
  color: #333;
  max-height: 300px;
  overflow-y: auto;
}

:deep(.note-popover .popover-actions) {
  margin-top: 12px;
  text-align: right;
  border-top: 1px solid #ebeef5;
  padding-top: 8px;
}
.monospace { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
</style>